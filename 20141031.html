<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Add encrypted USB storage to Chromebooks</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><img class="minime" src="/theme/images/minime.png" alt="Mini Me" height="38" width="38" /> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Friday 31 October 2014</p>
</div>

<!-- article -->
<h1>Add encrypted USB storage to Chromebooks</h1>
    <p class="modified"><i class="fa fa-wrench"></i>&nbsp; Last modified on Friday 21 August 2015</p>
<div id="article">
    <p>I love my <a class="reference external" href="http://www.circuidipity.com/c720-chromebook-to-jessiebook.html">Jessiebook</a> and the speedy performance of a solid-state drive (SSD). However 16GB of storage does not offer much room. One popular option is to open up the device and swap in a bigger SSD.</p>
<p>An alternative is to reserve the internal SSD for the OS and use an external USB storage device for data. My plan is to keep the USB stick attached to the Chromebook to provide extra storage that can be disconnected and re-connected at will.</p>
<div class="section" id="let-s-go">
<h2>Let's go!</h2>
<p>I picked up a <strong>SanDisk Ultra Fit 64GB USB 3.0</strong>  which are really tiny devices that barely extrude from the USB port. To guard against loss or theft its a good idea to encrypt the USB stick. I prepare the device using <strong>Linux Unified Key Setup</strong> (LUKS) and the <tt class="docutils literal">cryptsetup</tt> utility.</p>
<p><span class="warning">WARNING!</span> Make careful note of the drive and partition labels. The following steps <strong>will destroy all data</strong> currently stored on the drive.</p>
</div>
<div class="section" id="prepare">
<h2>0. Prepare</h2>
<p>Download <tt class="docutils literal">cryptsetup</tt> if not already installed. Connect the USB stick, leave it <strong>unmounted</strong>, and make note of the device label (<tt class="docutils literal">sdb</tt>, <tt class="docutils literal">sdc</tt> ...):</p>
<div class="highlight"><pre><span></span>$ lsblk
</pre></div>
</div>
<div class="section" id="partition">
<h2>1. Partition</h2>
<p>Create a single partition using <tt class="docutils literal">fdisk</tt> or <tt class="docutils literal">gparted</tt> that fills the entire drive. Encrypt the partition and assign a password:</p>
<div class="highlight"><pre><span></span>$ sudo cryptsetup luksFormat /dev/sdX1
$ sudo cryptsetup luksOpen /dev/sdX1 sdX1_crypt
</pre></div>
</div>
<div class="section" id="filesystem">
<h2>2. Filesystem</h2>
<p>Install a filesystem (example: <tt class="docutils literal">ext4</tt>) <a class="footnote-reference" href="#id2" id="id1">[1]</a> and mount the partition to gain access to the storage:</p>
<div class="highlight"><pre><span></span>$ sudo mkfs.ext4 -m <span class="m">1</span> -E <span class="nv">lazy_itable_init</span><span class="o">=</span>0,lazy_journal_init<span class="o">=</span><span class="m">0</span> /dev/mapper/sdX1_crypt
$ sudo mount -t ext4 /dev/mapper/sdX1_crypt /mnt
</pre></div>
<p>Before disconnecting the drive the partition must be unmounted and the encrypted device must be closed:</p>
<div class="highlight"><pre><span></span>$ sudo umount /mnt
$ sudo cryptsetup luksClose /dev/mapper/sdX1_crypt
</pre></div>
</div>
<div class="section" id="mountpoint">
<h2>3. Mountpoint</h2>
<p>Create a custom mountpoint (example <tt class="docutils literal">/media/USB</tt>):</p>
<div class="highlight"><pre><span></span>$ sudo mkdir /media/USB
</pre></div>
<p>Add entry in <tt class="docutils literal">/etc/fstab</tt> for mountpoint:</p>
<div class="highlight"><pre><span></span>/dev/mapper/sdX1_crypt  /media/USB   ext4    rw,user,exec,noatime,noauto,data<span class="o">=</span>ordered        <span class="m">0</span>       0
</pre></div>
</div>
<div class="section" id="boot">
<h2>4. Boot</h2>
<p>One wrinkle on the Chromebook is that attaching a USB stick makes the device always try to boot (and fail) from USB instead of internal storage. There appears to be no way to alter the default boot order in <strong>SeaBIOS</strong> except to rebuild the firmware. Plus I like that the USB boot option actually works! Simple workaround is just hit <tt class="docutils literal">ESC</tt> key at startup to access boot menu and manually choose the SSD.</p>
<p>Happy hacking!</p>
<div class="section" id="notes">
<h3>Notes</h3>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Writing <tt class="docutils literal">ext4</tt> with options <tt class="docutils literal"><span class="pre">-m</span> 1</tt> reduces reserved filesystem blocks from default 5% to 1% (grab extra space for non-root partitions) and <tt class="docutils literal">lazy_itable_init=0,lazy_journal_init=0</tt> initializes the inodes and journal at creation time vs a gradual process during mount times. If you wonder why your newly-formatted drive's activity LED is blinking away... install and run <tt class="docutils literal">iotop</tt> and take note of <tt class="docutils literal">ext4lazyinit</tt> and <a class="reference external" href="https://www.thomas-krenn.com/en/wiki/Ext4_Filesystem#Lazy_Initialization">Lazy Initialization</a>.</td></tr>
</tbody>
</table>
</div>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-chromebook.html">chromebook</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/c720-lubuntubook.html">Chromebook to Lubuntubook</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/lubuntu-trusty-hacks.html">20 small hacks after installing Lubuntu 14.04</a></p>
</div>


        <!-- analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89591498-1', 'auto');
  ga('send', 'pageview');

</script>
        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2016 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>