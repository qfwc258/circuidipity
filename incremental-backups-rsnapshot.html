<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Incremental backups</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><i class="fa fa-rocket"></i> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    <a href="archives.html">Archives</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Wednesday 12 August 2015</p>
</div>

<!-- article -->
<h1>Incremental backups</h1>
<div id="article">
    <p><a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">Raspberry Pi Home Server Hack #3 .:</a> Make incremental and automatic backups of a home folder using <strong>rsnapshot + cron</strong> (and manual backups via <strong>public transit</strong>).</p>
<div class="section" id="let-s-go">
<h2>Let's go!</h2>
<p>Backup strategy <strong>Version 0</strong> for my home folder was <strong>rsync</strong> + <strong>portable</strong> + <strong>subway</strong>. That is, I would simply make a periodic, manual sync of files using <strong>rsync</strong> from my primary computer to a <strong>portable</strong> encrypted <a class="reference external" href="http://www.circuidipity.com/encrypt-external-drive.html">USB hard drive</a>. Then ride the <strong>subway</strong> to a family/friend's place and swap drives (offsite backup).</p>
<p><strong>Version 1</strong> expanded to <strong>cron</strong> + <strong>rsync</strong> + <strong>Raspberry Pi</strong> + <strong>portable</strong> + <strong>subway</strong>. One of the advantages of setting up a <a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">Raspberry Pi home server</a> is providing a 24/7 uptime location to automatically (using <strong>cron</strong>) mirror my laptop's home folder over the local area network (LAN).</p>
<p>These backups are <strong>snapshots</strong> of home at a particular date. Pi server has a backup of 24 hours or less, the USB drive has another snapshot a few weeks old, the offsite another snapshot from a month ago. But there is no ordered progression of backups from Day 2 to Day 3, Week 4, Month 5, etc. One alternative is to every day stash an entire backup of my home folder but its a sub-optimal use of resources and would quickly fill a hard drive.</p>
<p>A much better solution is to use <a class="reference external" href="http://rsnapshot.org/">rsnapshot</a>  to make <strong>incremental backups</strong> and my backup strategy <strong>Version 2</strong> now incorporates:</p>
<ul class="simple">
<li><strong>cron</strong> + <strong>rsnapshot</strong> + <strong>cron</strong> + <strong>rsync</strong> + <strong>Raspberry Pi</strong> + <strong>portable</strong> + <strong>subway</strong>;</li>
<li>nightly a cron job runs <tt class="docutils literal">rsnapshot</tt> to sync <tt class="docutils literal">/home/</tt> and <tt class="docutils literal">/etc/</tt> to <tt class="docutils literal">/my/backup/location/daily.0/</tt>;</li>
<li><tt class="docutils literal">daily.0</tt> increments to <tt class="docutils literal">daily.1</tt>, <tt class="docutils literal">daily.1</tt> to <tt class="docutils literal">daily.2</tt>, etc. (retention set to 7 days)</li>
<li><tt class="docutils literal"><span class="pre">--hard-links</span></tt> is how <tt class="docutils literal">rsnapshot</tt> performs its minimal-storage-magic... if a file remains unchanged in the next backup a hard link is created so subsequent backups only contain modified files and links;</li>
<li>in the wee morning hours another cron job syncs <tt class="docutils literal">/my/backup/location/</tt> to Pi server;</li>
<li>every Saturday <tt class="docutils literal">daily.6</tt> rotates to <tt class="docutils literal">weekly.0</tt> (and <tt class="docutils literal">weekly.0</tt> to <tt class="docutils literal">weekly.1</tt> ... with 4 week retention);</li>
<li>on the 1st of the month <tt class="docutils literal">weekly.3</tt> rotates to <tt class="docutils literal">month.0</tt> (12 month retention);</li>
<li>every week or so I sync <tt class="docutils literal">/my/backup/location/</tt> to the USB drive;</li>
<li>every month or so I ride the subway to offsite storage and swap drives</li>
</ul>
</div>
<div class="section" id="id1">
<h2>0. Rsnapshot</h2>
<p>Install <tt class="docutils literal">rsnapshot</tt>, make a directory to store backups, and make a copy of the default config file:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install rsnapshot
<span class="nv">$ </span>mkdir /my/backup/location
<span class="nv">$ </span>sudo cp /etc/rsnapshot.conf /etc/rsnapshot.conf.default
</pre></div>
<p>Modify <tt class="docutils literal">/etc/rsnapshot.conf</tt> (important to separate fields with <strong>TABS</strong> not spaces). Example of a few tweaks:</p>
<div class="highlight"><pre>snapshot_root   /my/backup/location

cmd_cp          /bin/cp
cmd_rm          /bin/rm
cmd_rsync       /usr/bin/rsync
cmd_du          /usr/bin/du
cmd_rsnapshot_diff      /usr/bin/rsnapshot-diff

retain  daily   7
retain  weekly  4
retain  monthly 12

exclude_file    /home/USER/.rsyncExclude  <span class="c"># ...and create this file with list of things to exclude from backup</span>

link_dest       1

sync_first      <span class="m">1</span>  <span class="c"># allows better recovery in the event that rsnapshot is interrupted (see: ``man rsnapshot``)</span>

<span class="c"># LOCALHOST</span>
backup  /home/          localhost/
backup  /etc/           localhost/
</pre></div>
<p>Check config syntax and run backup test:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo rsnapshot configtest
<span class="nv">$ </span>sudo rsnapshot -t sync
</pre></div>
<p>If everything checks out OK go ahead and run:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo rsnapshot sync <span class="o">&amp;&amp;</span> sudo rsnapshot daily <span class="o">&amp;&amp;</span> rsnapshot du
</pre></div>
<p>Automate backups by running (as root user) <tt class="docutils literal">crontab <span class="pre">-e</span></tt> and create a job for <tt class="docutils literal">rsnapshot</tt>. Sample job:</p>
<div class="highlight"><pre><span class="c"># m h  dom mon dow   command</span>
<span class="m">50</span> <span class="m">23</span> * * *     /usr/bin/rsnapshot sync <span class="o">&amp;&amp;</span> /usr/bin/rsnapshot daily
<span class="m">40</span> <span class="m">22</span> * * <span class="m">6</span>     /usr/bin/rsnapshot weekly
<span class="m">30</span> <span class="m">21</span> <span class="m">1</span> * *     /usr/bin/rsnapshot monthly
</pre></div>
</div>
<div class="section" id="backup-the-backup">
<h2>1. Backup the backup</h2>
<p>Rsnapshot operates as a <strong>pull</strong> program: it pulls in backups from local and remote devices. Instead of juggling access permissions to allow the rsnapshot server to talk with other devices I decided to limit <tt class="docutils literal">rsnapshot</tt> to making backups on <tt class="docutils literal">localhost</tt> and use <a class="reference external" href="http://www.circuidipity.com/secure-remote-access-using-ssh-keys.html">my already-configured SSH key setup</a> to <strong>push</strong> a snapshot of the backup to my Raspberry Pi for remote storage.</p>
<div class="section" id="on-the-pi">
<h3>1.1 On the Pi</h3>
<p>Create a directory to store the backup:</p>
<div class="highlight"><pre><span class="nv">$ </span>mkdir /path/to/backup
</pre></div>
</div>
<div class="section" id="on-localhost">
<h3>1.2 On localhost</h3>
<p>Set the ip address and hostname of the Pi server in <tt class="docutils literal">/etc/hosts</tt>:</p>
<div class="highlight"><pre>192.168.1.88    raspberry.server
</pre></div>
<p>Test synching <tt class="docutils literal">/my/backup/location/</tt> on <tt class="docutils literal">localhost</tt> to <tt class="docutils literal"><span class="pre">raspberry.server:/path/to/backup/</span></tt> with the <tt class="docutils literal">rsync <span class="pre">--dry-run</span></tt> option (I exclude <tt class="docutils literal">/etc/</tt> from the backup):</p>
<div class="highlight"><pre>rsync --dry-run --archive --hard-links --numeric-ids --delete --exclude<span class="o">=</span>etc/ --verbose /my/backup/location/ raspberry.server:/path/to/backup/
</pre></div>
<p>If everything checks out OK drop <tt class="docutils literal"><span class="pre">--dry-run</span></tt> and re-run the command to make a proper backup.</p>
<p>I use <tt class="docutils literal">keychain</tt> to manage <a class="reference external" href="http://www.circuidipity.com/secure-remote-access-using-ssh-keys.html">SSH keys for password-less logins to the Pi</a>. Create a <tt class="docutils literal">backupSnap.sh</tt> shell script and place in <tt class="docutils literal">~/bin</tt>:</p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>
. <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.keychain/<span class="si">${</span><span class="nv">HOSTNAME</span><span class="si">}</span>-sh
rsync --archive --hard-links --numeric-ids --delete --exclude<span class="o">=</span>etc/ /my/backup/location/ <span class="nv">$1</span>
</pre></div>
<p>Automate the backups by creating a cron job (example that runs daily at 04:50):</p>
<div class="highlight"><pre><span class="c"># m h  dom mon dow   command</span>
<span class="m">50</span> <span class="m">4</span> * * *  /home/USERNAME/bin/backupSnap.sh raspberry.server:/path/to/backup/
</pre></div>
</div>
</div>
<div class="section" id="external-drive-and-offsite-storage">
<h2>2. External drive and offsite storage</h2>
<p>I connect my USB drive and sync the backup to the device:</p>
<div class="highlight"><pre><span class="nv">$ </span>/home/USERNAME/bin/backupSnap.sh /media/USB/path/to/backup/
</pre></div>
<p>... and take my hard drive for <a class="reference external" href="http://ttc.ca/Routes/General_Information/Maps/index.jsp">a ride on the subway</a> to say hello to my offsite storage!</p>
<p>Happy hacking!</p>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-network.html">network</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-ssh.html">ssh</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-crypto.html">crypto</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-debian.html">debian</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-raspberry-pi.html">raspberry pi</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/x11-forwarding-ssh.html">Run remote X applications on a local display</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/rather-ashes-than-dust.html">I would rather be ashes than dust</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2015 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>