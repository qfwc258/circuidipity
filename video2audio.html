<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Video2Audio - Search for video and copy/convert to MP3</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><i class="fa fa-rocket"></i> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    <a href="archives.html">Archives</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Thursday 28 March 2013</p>
</div>

<!-- article -->
<h1>Video2Audio - Search for video and copy/convert to MP3</h1>
<div id="article">
    <p>I think I have discovered the secret to learning to  program. Write programs!</p>
<p>... <em>(cue applause) Thank you for coming don't forget to tip your server and good-night to all ...</em></p>
<p>OK. Perhaps a bit more explanation. Great programming books and online resources and sample problems are <em>accelerants</em> but trying to program a solution to your <em>own private thing</em> is the <em>spark</em>. Write a bit of code every day that you need and that <em>pushes</em> the learning engine ever higher and makes it stutter stop start in the rarified air. Feel the wonderful little jolts to the brain when the code <em>works</em>. Then do it <em>again</em>. Spark. Code. Repeat.</p>
<p>Building on what I learned last week using the <tt class="docutils literal">find</tt> command in <a class="reference external" href="http://www.circuidipity.com/tartime-find-time-tar.html">tarTime</a> I thought ... <em>How about a shell script that would allow me to find a bunch of videos accumulated over TIME and would copy/convert them to MP3 audio? Or instead of TIME as my search parameter maybe only certain TYPES of video or use both TIME and TYPE</em>. Example: only convert MP4 videos modified in the last 3 days?</p>
<p>So I wanted to code a shell script that would:</p>
<ul class="simple">
<li>copy/convert either a single video or a batch of videos that satisfy a SEARCH paramater</li>
<li>SEARCH using <em>find</em> for videos modified since TIME and/or of a certain TYPE (MP4,FLV, etc.)</li>
<li>list all the matching files or ...</li>
<li>... convert to MP3</li>
</ul>
<p><em>Update 2013-04-04:</em> Used <tt class="docutils literal">set noglob</tt> to forego wildcard expansion of NAME arguments that broke find command's recursive search, added a counter function to return total number of videos returned by find, and the <tt class="docutils literal">getopts</tt> shell built-in to process positional parameters and their arguments.</p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#: VARIABLES</span>
<span class="nv">Scriptname</span><span class="o">=</span><span class="s2">&quot;Video2Audio&quot;</span>
<span class="nv">Description</span><span class="o">=</span><span class="s2">&quot;Recursive search of PWD for video and copy/convert to MP3&quot;</span>
<span class="nv">Synopsis</span><span class="o">=</span><span class="s2">&quot;$Scriptname [-v|-h|-a|-n [FILE]|-t [+-][TIME]]&quot;</span>
<span class="c"># -------- #</span>
<span class="nv">RequiredPrograms</span><span class="o">=</span><span class="s2">&quot;findutils, ffmpeg, libmp3lame0&quot;</span>
<span class="nv">InvalidInput</span><span class="o">=</span><span class="s2">&quot;is invalid input. Please select &#39;Y(es)&#39; or &#39;N(o)&#39; ...&quot;</span>
<span class="nv">Codecs</span><span class="o">=</span><span class="s2">&quot;MP4:FLV:AVI:M4V:MKV:MOV:WMV&quot;</span>
<span class="nv">Converter</span><span class="o">=</span><span class="s2">&quot;ffmpeg&quot;</span>
<span class="nv">Mp3Config</span><span class="o">=</span><span class="s2">&quot;-acodec libmp3lame -aq 0 -ac 2 -ar 44100&quot;</span>
<span class="nv">InameList</span><span class="o">=(</span> -iname <span class="se">\*</span>.mp4 -o -iname <span class="se">\*</span>.flv -o -iname <span class="se">\*</span>.avi -o -iname <span class="se">\*</span>.m4v -o -iname <span class="se">\*</span>.mkv -o -iname <span class="se">\*</span>.mov -o -iname <span class="se">\*</span>.wmv <span class="o">)</span>
<span class="nv">FindNameAll</span><span class="o">=</span><span class="s2">&quot;*&quot;</span>
<span class="nv">FindName</span><span class="o">=</span>
<span class="nv">FindTime</span><span class="o">=</span>

<span class="c">#: FUNCTIONS</span>
VersionInfo<span class="o">()</span>
<span class="o">{</span>
cat <span class="s">&lt;&lt; _EOF_</span>
<span class="s">$Scriptname, Version $Version</span>
<span class="s">_EOF_</span>
<span class="o">}</span>

HelpInfo<span class="o">()</span>
<span class="o">{</span>
cat <span class="s">&lt;&lt; _EOF_</span>
<span class="s">Usage: $Synopsis</span>
<span class="s">${Description}. Supported Codecs: $Codecs</span>

<span class="s">Debian package requirements: $RequiredPrograms</span>

<span class="s">OPTIONS</span>
<span class="s">-v  display version</span>
<span class="s">-h  display help</span>
<span class="s">-t  match videos last modified [+-][digit][m[inutes]|d[ays] ago</span>
<span class="s">-n  match video NAME</span>
<span class="s">-a  match all videos</span>

<span class="s">EXAMPLES</span>
<span class="s"># convert a single video</span>
<span class="s">Video2Audio -n VIDEO1.mp4</span>

<span class="s">... or batch-convert ...</span>

<span class="s"># convert videos modified less than 30 minutes ago</span>
<span class="s">Video2Audio -t -30m</span>
<span class="s"># convert videos modified more than 5 days ago</span>
<span class="s">Video2Audio -t +5d</span>
<span class="s"># convert all MP4-encoded videos (quotes are important)</span>
<span class="s">Video2Audio -n &quot;*mp4&quot;</span>
<span class="s"># convert all FLV-encoded videos modified less than 90 minutes ago</span>
<span class="s">Video2Audio -n &quot;*flv&quot; -t -90m</span>
<span class="s"># convert all videos</span>
<span class="s">Video2Audio -a</span>
<span class="s">_EOF_</span>
<span class="o">}</span>

ModField<span class="o">()</span>
<span class="o">{</span>
<span class="k">if</span> <span class="o">[[</span> -z <span class="nv">$FindTime</span> <span class="o">]]</span>
<span class="k">then</span>
<span class="k">    </span><span class="nv">ModUnits</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">else</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="nv">$FindTime</span> <span class="o">=</span>~ ^<span class="o">[</span>+-<span class="o">]</span>*<span class="o">[</span>0-9<span class="o">]</span>+<span class="o">[</span>m<span class="o">]</span><span class="nv">$ </span><span class="o">]]</span>
    <span class="k">then</span>
<span class="k">            </span><span class="nv">ModUnits</span><span class="o">=</span><span class="s2">&quot;-mmin ${FindTime%m}&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$FindTime</span> <span class="o">=</span>~ ^<span class="o">[</span>+-<span class="o">]</span>*<span class="o">[</span>0-9<span class="o">]</span>+<span class="o">[</span>d<span class="o">]</span><span class="nv">$ </span><span class="o">]]</span>
    <span class="k">then</span>
<span class="k">            </span><span class="nv">ModUnits</span><span class="o">=</span><span class="s2">&quot;-mtime ${FindTime%d}&quot;</span>
    <span class="k">else</span>
<span class="k">            </span><span class="nb">printf</span> <span class="s2">&quot;Error: &#39;-t&#39; option requires argument in correct format ...\n&quot;</span>
            <span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
            HelpInfo
            <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="o">}</span>

Penguinista<span class="o">()</span>
<span class="o">{</span>
cat <span class="s">&lt;&lt; _EOF_</span>

<span class="s">(O&lt;</span>
<span class="s">(/)_</span>
<span class="s">_EOF_</span>
<span class="o">}</span>

FindNameCount<span class="o">()</span>
<span class="o">{</span>
<span class="nb">set</span> -o noglob   <span class="c"># no pathname expansion</span>
ModField
<span class="nb">local </span>counter
<span class="nv">counter</span><span class="o">=</span>/tmp/FindNameCount
find -L . -iname <span class="nv">$FindName</span> -type f <span class="nv">$ModUnits</span> -print 2&gt;/dev/null | tee -a <span class="nv">$counter</span>
<span class="nb">printf</span> <span class="s2">&quot;Found $( wc -l $counter | awk {&#39;print $1&#39;} ) file(s).\n&quot;</span>
rm <span class="nv">$counter</span>
<span class="nb">set</span> +o noglob
<span class="o">}</span>

FindTimeCount<span class="o">()</span>
<span class="o">{</span>
ModField
<span class="nb">local </span>counter
<span class="nv">counter</span><span class="o">=</span><span class="k">$(</span> find -L . <span class="se">\(</span> <span class="s2">&quot;${InameList[@]}&quot;</span> <span class="se">\)</span> -type f <span class="nv">$ModUnits</span> -print 2&gt;/dev/null | tee /dev/tty | wc -l <span class="k">)</span>
<span class="nb">printf</span> <span class="s2">&quot;Found $counter file(s).\n&quot;</span>
<span class="o">}</span>

<span class="c">#: LET&#39;S ROLL ...</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>
<span class="k">then</span>
<span class="k">    while </span><span class="nb">getopts</span> “n:t:ahv” OPTION
    <span class="k">do</span>
<span class="k">            case</span> <span class="nv">$OPTION</span> in
                    a <span class="o">)</span>     <span class="nv">FindName</span><span class="o">=</span><span class="nv">$FindNameAll</span>
                            <span class="nb">break</span>
                            ;;
                    n <span class="o">)</span>     <span class="nv">FindName</span><span class="o">=</span><span class="nv">$OPTARG</span>
                            ;;
                    t <span class="o">)</span>     <span class="nv">FindTime</span><span class="o">=</span><span class="nv">$OPTARG</span>
                            ;;
                    h <span class="o">)</span>     HelpInfo
                            <span class="nb">exit</span>
                            ;;
                    v <span class="o">)</span>     VersionInfo
                            <span class="nb">exit</span>
                            ;;
                    ? <span class="o">)</span>     HelpInfo
                            <span class="nb">exit </span>1
                            ;;
            <span class="k">esac</span>
<span class="k">    done</span>
<span class="k">else</span>
<span class="k">    </span><span class="nb">printf</span> <span class="s2">&quot;Error: Video2Audio requires at least 1 parameter ...\n&quot;</span>
    <span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
    HelpInfo
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="o">(</span> -n <span class="nv">$FindTime</span> <span class="o">&amp;&amp;</span> -n <span class="nv">$FindName</span> <span class="o">)</span> <span class="o">||</span> -n <span class="nv">$FindName</span> <span class="o">]]</span>
<span class="k">then</span>
<span class="k">    </span>FindNameCount
    <span class="k">while </span><span class="nb">true</span>
<span class="nb">    </span><span class="k">do</span>
<span class="k">            </span><span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
            <span class="nb">read</span> -n 1 -p <span class="s2">&quot;Copy/convert videos to MP3? [Yn] &gt; &quot;</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$REPLY&quot;</span> <span class="o">==</span> <span class="o">[</span>Yy<span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;$REPLY&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>
            <span class="k">then</span>
<span class="k">                    </span>find -L . -iname <span class="s2">&quot;$FindName&quot;</span> -type f <span class="nv">$ModUnits</span> <span class="se">\</span>
                            -exec <span class="nv">$Converter</span> -i <span class="s1">&#39;{}&#39;</span> <span class="nv">$Mp3Config</span> <span class="s1">&#39;{}&#39;</span>.mp3 <span class="se">\;</span> <span class="se">\</span>
                            -exec sh -c <span class="s1">&#39;mv &quot;$0&quot; &quot;${0%.*.mp3}.mp3&quot;&#39;</span> <span class="s1">&#39;{}&#39;</span>.mp3 <span class="se">\;</span>
                            <span class="c"># file name {} passed to shell as its 0th argument and</span>
                            <span class="c"># script uses shell variable $0 to refer to the file</span>
                    <span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
                    <span class="nb">printf</span> <span class="s2">&quot;$(Penguinista)  All done.\n&quot;</span>
                    <span class="nb">exit</span>
<span class="nb">            </span><span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$REPLY&quot;</span> <span class="o">==</span> <span class="o">[</span>nN<span class="o">]</span> <span class="o">]]</span>
            <span class="k">then</span>
<span class="k">                    </span><span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
                    <span class="nb">printf</span> <span class="s2">&quot;$(Penguinista)  OK. Nothing done.\n&quot;</span>
                    <span class="nb">exit</span>
<span class="nb">            </span><span class="k">else</span>
<span class="k">                    </span><span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
                    <span class="nb">printf</span> <span class="s2">&quot;&#39;$REPLY&#39; $InvalidInput\n&quot;</span>
            <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> -n <span class="nv">$FindTime</span> <span class="o">]]</span>
<span class="k">then</span>
<span class="k">    </span>FindTimeCount
    <span class="k">while </span><span class="nb">true</span>
<span class="nb">    </span><span class="k">do</span>
<span class="k">            </span><span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
            <span class="nb">read</span> -n 1 -p <span class="s2">&quot;Copy/convert videos to MP3? [Yn] &gt; &quot;</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$REPLY&quot;</span> <span class="o">==</span> <span class="o">[</span>Yy<span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;$REPLY&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>
            <span class="k">then</span>
<span class="k">                    </span>find -L . <span class="se">\(</span> <span class="s2">&quot;${InameList[@]}&quot;</span> <span class="se">\)</span> -type f <span class="nv">$ModUnits</span> <span class="se">\</span>
                            -exec <span class="nv">$Converter</span> -i <span class="s1">&#39;{}&#39;</span> <span class="nv">$Mp3Config</span> <span class="s1">&#39;{}&#39;</span>.mp3 <span class="se">\;</span> <span class="se">\</span>
                            -exec sh -c <span class="s1">&#39;mv &quot;$0&quot; &quot;${0%.*.mp3}.mp3&quot;&#39;</span> <span class="s1">&#39;{}&#39;</span>.mp3 <span class="se">\;</span>
                    <span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
                    <span class="nb">printf</span> <span class="s2">&quot;$(Penguinista)  All done.\n&quot;</span>
                    <span class="nb">exit</span>
<span class="nb">            </span><span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$REPLY&quot;</span> <span class="o">==</span> <span class="o">[</span>nN<span class="o">]</span> <span class="o">]]</span>
            <span class="k">then</span>
<span class="k">                    </span><span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
                    <span class="nb">printf</span> <span class="s2">&quot;$(Penguinista)  OK. Nothing done.\n&quot;</span>
                    <span class="nb">exit</span>
<span class="nb">            </span><span class="k">else</span>
<span class="k">                    </span><span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
                    <span class="nb">printf</span> <span class="s2">&quot;&#39;$REPLY&#39; $InvalidInput\n&quot;</span>
            <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">fi</span>
</pre></div>
<div class="section" id="examples">
<h2>Examples</h2>
<p>Video2Audio can copy/convert videos to MP3 either one at a time <tt class="docutils literal">Video2Audio <span class="pre">-n</span> VIDEO1.mp4</tt> or perform a batch-conversion that satisfies a SEARCH paramater ...</p>
<div class="highlight"><pre><span class="c"># convert videos modified less than 30 minutes ago</span>
<span class="nv">$ </span>Video2Audio -t -30m

<span class="c"># convert videos modified more than 5 days ago</span>
<span class="nv">$ </span>Video2Audio -t +5d

<span class="c"># convert all MP4-encoded videos (quotes are important)</span>
<span class="nv">$ </span>Video2Audio -n <span class="s2">&quot;*mp4&quot;</span>

<span class="c"># convert all FLV-encoded videos modified less than 90 minutes ago</span>
<span class="nv">$ </span>Video2Audio -n <span class="s2">&quot;*flv&quot;</span> -t -90m

<span class="c"># convert all videos</span>
<span class="nv">$ </span>Video2Audio -a
</pre></div>
<p>Running <tt class="docutils literal">Video2Audio <span class="pre">-h</span></tt> displays available options.</p>
<p>This week I learned about <em>bash arrays</em>. They allow you to assign multiple values to a variable. I used them twice in this shell script: 1/ to list video FILETYPES for <em>find</em>; 2/ to construct a list of NAMES of videos to be converted to audio. Also the find <em>exec</em> option is put to good use and trying to get the syntax right for file manipulation is a bit of a puzzle.</p>
<p>But it <em>works</em>. I use this script to generate MP3 files and <a class="reference external" href="http://www.circuidipity.com/tartime-find-time-tar.html">tarTime</a> to bundle them up into a single convenient package.</p>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-shell.html">shell</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-programming.html">programming</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/tartime-find-time-tar.html">TarTime - Match files and generate a tar archive</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/fidel.html">Fidel - Find and delete files</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <a href="/colophon.html">Colophon</a>
    <a href="/tags.html">Tags</a>
    <a href="/"><i class="fa fa-rocket"></i> Home</a><br />
    <span class="noWrap">Copyright &#169; 2014</span> and
    <a class="invisibleLink" rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
    <img alt="Creative Commons BY-NC-SA License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a>
    by <span class="noWrap"><a rel="author" href="/">Daniel Wayne Armstrong</a></span>&nbsp;
    <span class="noWrap"><i class="fa fa-globe"></i> Find me at <span class="whoa">daniel at circuidipity dot com</span></span></p>
</div></body>
</html>