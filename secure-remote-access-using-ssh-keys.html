<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Secure remote access using SSH keys</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><i class="fa fa-rocket"></i> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    <a href="archives.html">Archives</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Monday 02 February 2015</p>
</div>

<!-- article -->
<h1>Secure remote access using SSH keys</h1>
    <p class="modified"><i class="fa fa-wrench"></i>&nbsp; Last modified on Monday 16 February 2015</p>
<div id="article">
    <p><a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">Raspberry Pi Home Server Hack #1 &gt;&gt;</a> Create cryptographic keys and disable password logins to make remote machines more secure.</p>
<p><strong>OpenSSH</strong> is a toolkit for securing communication with Unix-like remote machines and services and supports authenticating users with a public and private <strong>key pair</strong>. Michael Lucas, author of <a class="reference external" href="https://www.michaelwlucas.com/nonfiction/ssh-mastery">OpenSSH Mastery</a>, describes the risk of passwords in SSH:</p>
<blockquote>
<p>For the last few years, a network of compromised machines dubbed the &quot;Hail Mary Cloud&quot; has scanned the Internet for SSH servers. When a member of this cloud finds an SSH server, it lets the other machines in the network know about it. The cloud then methodically tries possible usernames and passwords. One host on the network tries a few times, then another, then another. Blocking individual IP addresses is not a useful defense, because each address is used only a few times.</p>
<p>Any one attempt has low odds of guessing successfully. The attempts are constant. They never end. Eventually [some automated attacker] will get lucky and break into your server. It might be tomorrow, or next year, but it _will_ happen. To stop these types of attacks, you can either use packet filtering to block public access to your SSH server, or you can eliminate passwords on your servers. User keys let you eliminate passwords.</p>
</blockquote>
<p>Configuring SSH key authentication between a home server and client sounds like a good idea.</p>
<div class="section" id="let-s-go">
<h2>Let's go!</h2>
</div>
<div class="section" id="install">
<h2>0. Install</h2>
<p>Home server is a <a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">Raspberry Pi running Raspbian</a> and client is a <a class="reference external" href="http://www.circuidipity.com/c720-lubuntubook.html">Chromebook running Lubuntu 14.04</a>.</p>
<div class="section" id="on-the-server">
<h3>On the server</h3>
<ul class="simple">
<li>install <tt class="docutils literal"><span class="pre">openssh-server</span></tt> (pre-installed in Raspbian) and create an SSH configuration in the home directory of users who requires access to the system:</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install openssh-server
<span class="nv">$ </span>mkdir ~/.ssh <span class="o">&amp;&amp;</span> chmod 700 ~/.ssh <span class="o">&amp;&amp;</span> touch ~/.ssh/authorized_keys <span class="o">&amp;&amp;</span> chmod 600 ~/.ssh/authorized_keys
</pre></div>
<ul class="simple">
<li>collect key fingerprints from the server:</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>ssh-keygen -lf /etc/ssh/ssh_host_dsa_key.pub &gt;&gt; ~/.ssh/keys.txt
<span class="nv">$ </span>ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub &gt;&gt; ~/.ssh/keys.txt
<span class="nv">$ </span>ssh-keygen -lf /etc/ssh/ssh_host_rsa_key.pub &gt;&gt; ~/.ssh/keys.txt
</pre></div>
<p>... and give <tt class="docutils literal">keys.txt</tt> to users to compare signature when connecting for the first time</p>
<ul class="simple">
<li><strong>optional:</strong> edit <tt class="docutils literal">/etc/ssh/sshd_config</tt> adding specific users to be granted system access (<strong>disabling</strong> all others by default):</li>
</ul>
<div class="highlight"><pre>AllowUsers USERNAME1 USERNAME2
</pre></div>
<p>Save and restart SSH with the new config by running:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo service ssh restart
</pre></div>
</div>
<div class="section" id="on-the-client">
<h3>On the client</h3>
<ul class="simple">
<li>install <tt class="docutils literal"><span class="pre">openssh-client</span></tt> and create the SSH folder in the user home directory:</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install openssh-client
<span class="nv">$ </span>mkdir ~/.ssh <span class="o">&amp;&amp;</span> chmod 700 ~/.ssh
</pre></div>
<ul class="simple">
<li><strong>optional:</strong> create an entry in <tt class="docutils literal"><span class="pre">~/.ssh/config</span></tt> with the login options for a server - for example:</li>
</ul>
<div class="highlight"><pre>Host raspberry
HostName 192.168.1.88
Port 22
User pi
</pre></div>
</div>
</div>
<div class="section" id="generate-keys">
<h2>1. Generate keys</h2>
<div class="section" id="id1">
<h3>On the client</h3>
<ul class="simple">
<li>generate keys by running:</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>ssh-keygen -t rsa -C <span class="s2">&quot;$(whoami)@$(hostname)-$(date -I)&quot;</span>
</pre></div>
<ul class="simple">
<li>upload the public key to the server and append it to <tt class="docutils literal"><span class="pre">~/.ssh/authorized_keys</span></tt>:</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>cat ~/.ssh/id_rsa.pub | ssh SERVER <span class="s2">&quot;cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="test">
<h2>2. Test</h2>
<div class="section" id="id2">
<h3>On the client</h3>
<p>Graphical display managers like <tt class="docutils literal">gdm</tt> will automatically check a user account for SSH keys upon login. A pop-up box will prompt for the passphrase and the key will be added to the desktop session.</p>
<p>If logging into a console, tell SSH that you have keys by running <tt class="docutils literal"><span class="pre">ssh-add</span></tt>:</p>
<div class="highlight"><pre><span class="nv">$ </span>ssh-add
<span class="nv">$ </span>Enter passphrase <span class="k">for</span> /home/gaff/.ssh/id_rsa:
Identity added: /home/gaff/.ssh/id_rsa <span class="o">(</span>/home/gaff/.ssh/id_rsa<span class="o">)</span>
</pre></div>
<p>All SSH sessions launched from this console will access this user key stored in memory. Make sure to test the connection before disabling password logins:</p>
<div class="highlight"><pre><span class="nv">$ </span>ssh 192.168.1.88
Last login: Thu Sep 11 23:46:28 2014 from kambei.lan
<span class="nv">$ </span>uname -n
pi
</pre></div>
<p>No request to enter a passphrase indicates SSH key authentication is properly configured.</p>
</div>
</div>
<div class="section" id="disable-password-logins">
<h2>3. Disable password logins</h2>
<div class="section" id="id3">
<h3>On the server</h3>
<ul class="simple">
<li>edit <tt class="docutils literal">/etc/ssh/sshd_config</tt>:</li>
</ul>
<div class="highlight"><pre>PubkeyAuthentication yes
ChallengeResponseAuthentication no
PasswordAuthentication no
UsePAM no
</pre></div>
<p>... and restart the SSH server:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo service ssh restart
</pre></div>
</div>
</div>
<div class="section" id="key-management">
<h2>4. Key management</h2>
<p><a class="reference external" href="http://www.funtoo.org/Keychain">Keychain</a> is an OpenSSH key manager. From the package description:</p>
<blockquote>
When keychain is run, it checks for a running ssh-agent, otherwise it starts one. It saves the ssh-agent environment variables to <tt class="docutils literal"><span class="pre">~/.keychain/$HOSTNAME-sh</span></tt>, so that subsequent logins and non-interactive shells such as cron jobs can source the file and make passwordless ssh connections.  In addition, when keychain runs, it verifies that the key files specified on the command-line are known to ssh-agent, otherwise it loads them, prompting you for a password if necessary.</blockquote>
<div class="section" id="id4">
<h3>On the client</h3>
<ul class="simple">
<li>install:</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install keychain
</pre></div>
<ul class="simple">
<li>configure <tt class="docutils literal"><span class="pre">~/.bashrc</span></tt>:</li>
</ul>
<div class="highlight"><pre><span class="c"># setup keychain - ssh-agent management</span>
keychain ~/.ssh/id_rsa
. ~/.keychain/<span class="nv">$HOSTNAME</span>-sh
</pre></div>
<ul class="simple">
<li>flush all cached keys from memory with:</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>keychain --clear
</pre></div>
<ul class="simple">
<li>if using <a class="reference external" href="http://www.circuidipity.com/tmux.html">tmux</a> enable persistent SSH key management across sessions by editing <tt class="docutils literal"><span class="pre">~/.tmux.conf</span></tt>:</li>
</ul>
<div class="highlight"><pre><span class="nb">set</span>-option -g update-environment <span class="s2">&quot;DISPLAY SSH_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY&quot;</span>
</pre></div>
<p>Happy hacking!</p>
</div>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-networks.html">networks</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/raspberry-pi-home-server.html">There's no place like [a Raspberry Pi] Home [Server]</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/backup-home.html">Backup /home</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2015 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>