<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Secure remote access using SSH keys</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><img class="minime" src="/theme/images/minime.png" alt="Mini Me" height="38" width="38" /> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Monday 02 February 2015</p>
</div>

<!-- article -->
<h1>Secure remote access using SSH keys</h1>
    <p class="modified"><i class="fa fa-wrench"></i>&nbsp; Last modified on Tuesday 02 February 2016</p>
<div id="article">
    <p><a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">Home Server Project #1 .:</a> Create cryptographic keys and <strong>disable password logins</strong> to make remote machines more secure.</p>
<div class="section" id="let-s-go">
<h2>Let's go!</h2>
<p><strong>Server</strong> is a <a class="reference external" href="http://www.circuidipity.com/laptop-home-server.html">netbook</a> running <a class="reference external" href="http://www.circuidipity.com/tag-ubuntu.html">Ubuntu</a> configured for SSH logins from a Linux <strong>client</strong>.</p>
<div class="section" id="install">
<h3>0. Install</h3>
<div class="section" id="on-the-server">
<h4>On the server</h4>
<p>Install <tt class="docutils literal"><span class="pre">openssh-server</span></tt> and create an SSH configuration in the home directory of users who requires access to the system ...</p>
<div class="highlight"><pre><span></span>$ sudo apt install openssh-server
$ mkdir ~/.ssh <span class="o">&amp;&amp;</span> chmod <span class="m">700</span> ~/.ssh <span class="o">&amp;&amp;</span> touch ~/.ssh/authorized_keys <span class="o">&amp;&amp;</span> chmod <span class="m">600</span> ~/.ssh/authorized_keys
</pre></div>
<p>Collect key fingerprints ...</p>
<div class="highlight"><pre><span></span>$ ssh-keygen -lf /etc/ssh/ssh_host_dsa_key.pub &gt;&gt; ~/.ssh/keys.txt
$ ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub &gt;&gt; ~/.ssh/keys.txt
$ ssh-keygen -lf /etc/ssh/ssh_host_rsa_key.pub &gt;&gt; ~/.ssh/keys.txt
</pre></div>
<p>... and give <tt class="docutils literal">keys.txt</tt> to users to compare signature when connecting for the first time.</p>
</div>
<div class="section" id="on-the-client">
<h4>On the client</h4>
<p>Install <tt class="docutils literal"><span class="pre">openssh-client</span></tt> and create the SSH folder in <tt class="docutils literal">$HOME</tt> ...</p>
<div class="highlight"><pre><span></span>$ sudo apt install openssh-client
$ mkdir ~/.ssh <span class="o">&amp;&amp;</span> chmod <span class="m">700</span> ~/.ssh
</pre></div>
<p>Create <tt class="docutils literal"><span class="pre">~/.ssh/config</span></tt> to hold <strong>aliases</strong> with the login options for a server. Example ...</p>
<div class="highlight"><pre><span></span>Host netbook.lan
HostName 192.168.1.88
Port 22
User foo
</pre></div>
<p><strong>Test</strong> SSH password login to the server ...</p>
<div class="highlight"><pre><span></span>$ ssh netbook.lan
foo@192.168.1.88<span class="err">&#39;</span>s password:
Last login: Thu Feb <span class="m">19</span> 18:07:48 <span class="m">2015</span> from chromebook.lan
$
</pre></div>
<p><strong>Optional:</strong> Use <a class="reference external" href="http://www.circuidipity.com/ddns-openwrt.html">Dynamic DNS (DDNS)</a> to configure access to a home server from outside the local area network (LAN).</p>
</div>
</div>
<div class="section" id="keys">
<h3>1. Keys</h3>
<div class="section" id="id1">
<h4>On the client</h4>
<p>Generate SSH keys ...</p>
<div class="highlight"><pre><span></span>$ ssh-keygen -t rsa -C <span class="s2">&quot;</span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">@</span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">-</span><span class="k">$(</span>date -I<span class="k">)</span><span class="s2">&quot;</span>
</pre></div>
<p>Upload the <strong>public key</strong> to the server and append to <tt class="docutils literal"><span class="pre">~/.ssh/authorized_keys</span></tt> ...</p>
<div class="highlight"><pre><span></span>$ cat ~/.ssh/id_rsa.pub <span class="p">|</span> ssh netbook.lan <span class="s2">&quot;cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span>
</pre></div>
<p>Graphical display managers like <tt class="docutils literal">gdm</tt> will automatically check a user account for SSH keys upon login. A pop-up box will prompt for the passphrase and the key will be added to the desktop session.</p>
<p>If logging into a console, tell SSH that you have keys by running <tt class="docutils literal"><span class="pre">ssh-add</span></tt> ...</p>
<div class="highlight"><pre><span></span>$ ssh-add
$ Enter passphrase <span class="k">for</span> /home/foo/.ssh/id_rsa:
Identity added: /home/foo/.ssh/id_rsa <span class="o">(</span>/home/foo/.ssh/id_rsa<span class="o">)</span>
</pre></div>
<p>All SSH sessions launched from this console will access this user key stored in memory. Make sure to test the connection before disabling password logins ...</p>
<div class="highlight"><pre><span></span>$ ssh netbook.lan
Last login: Thu Feb <span class="m">19</span> 18:22:42 <span class="m">2015</span> from chromebook.lan
$
</pre></div>
<p>No request for passphrase indicates SSH key authentication is properly configured.</p>
</div>
</div>
<div class="section" id="disable-password-logins">
<h3>2. Disable password logins</h3>
<div class="section" id="id2">
<h4>On the server</h4>
<p>Make the following modifications in <tt class="docutils literal">/etc/ssh/sshd_config</tt> ...</p>
<div class="highlight"><pre><span></span>PermitRootLogin no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
PasswordAuthentication no
UsePAM no
</pre></div>
<p>Restart SSH ...</p>
<div class="highlight"><pre><span></span>$ sudo systemctl restart ssh
</pre></div>
</div>
</div>
<div class="section" id="key-management">
<h3>3. Key management</h3>
<p><a class="reference external" href="http://www.funtoo.org/Keychain">Keychain</a> is an OpenSSH key manager. From the package description ...</p>
<blockquote>
When keychain is run, it checks for a running ssh-agent, otherwise it starts one. It saves the ssh-agent environment variables to <tt class="docutils literal"><span class="pre">~/.keychain/$HOSTNAME-sh</span></tt>, so that subsequent logins and non-interactive shells such as cron jobs can source the file and make passwordless ssh connections.  In addition, when keychain runs, it verifies that the key files specified on the command-line are known to ssh-agent, otherwise it loads them, prompting you for a password if necessary.</blockquote>
<div class="section" id="id3">
<h4>On the client</h4>
<p>Install ...</p>
<div class="highlight"><pre><span></span>$ sudo apt install keychain
</pre></div>
<p>Configure <tt class="docutils literal"><span class="pre">~/.bashrc</span></tt> ...</p>
<div class="highlight"><pre><span></span><span class="c1"># setup keychain - ssh-agent management</span>
keychain ~/.ssh/id_rsa
. ~/.keychain/<span class="nv">$HOSTNAME</span>-sh
</pre></div>
<p>Flush all cached keys from memory ...</p>
<div class="highlight"><pre><span></span>$ keychain --clear
</pre></div>
<p><strong>Optional:</strong> If using <a class="reference external" href="http://www.circuidipity.com/tmux.html">tmux</a> enable persistent SSH key management across sessions by editing <tt class="docutils literal"><span class="pre">~/.tmux.conf</span></tt> ...</p>
<div class="highlight"><pre><span></span>set-option -g update-environment <span class="s2">&quot;DISPLAY SSH_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY&quot;</span>
</pre></div>
<p>Happy hacking!</p>
</div>
</div>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-ssh.html">ssh</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-server.html">server</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-network.html">network</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/raspberry-pi-home-server.html">There's no place like [a Raspberry Pi] Home [Server]</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/backup-home.html">Backup home</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2016 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>