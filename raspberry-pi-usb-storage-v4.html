<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Run a Raspberry Pi from USB storage v4.0</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><i class="fa fa-rocket"></i> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    <a href="archives.html">Archives</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Saturday 25 July 2015</p>
</div>

<!-- article -->
<h1>Run a Raspberry Pi from USB storage v4.0</h1>
<div id="article">
    <p><a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">Raspberry Pi Home Server Hack #0 .:</a> I am exploring the use of my Pi as <strong>24/7 uptime home server</strong>. Hard drives offer a more robust storage media than a Pi's default choice of microSD cards and that is what I decide to use. <a class="footnote-reference" href="#id3" id="id1">[1]</a> I put my plan in motion using <strong>Debian</strong> and move <tt class="docutils literal">rootfs</tt> from a microSD to a powered 1TB USB 3.5&quot; hard drive with encrypted storage.</p>
<div class="section" id="let-s-go">
<h2>Let's go!</h2>
<p>Current setup:</p>
<ul class="simple">
<li>Raspberry Pi 2 Model B</li>
<li>5V 2A microUSB power adapter</li>
<li>ethernet cable</li>
<li>HDMI display + USB keyboard (initial setup)</li>
<li>USB hard drive with 3 partitions: <tt class="docutils literal">root</tt>, encrypted <tt class="docutils literal">swap</tt> + <tt class="docutils literal">storage</tt></li>
<li>Debian <tt class="docutils literal"><span class="pre">jessie-rpi2-20150705</span></tt></li>
<li>4GB microSD card (initial setup and <tt class="docutils literal">boot</tt> partition)</li>
</ul>
<p>Previous versions:</p>
<ul class="simple">
<li>v3.0 - <a class="reference external" href="http://www.circuidipity.com/run-a-raspberry-pi-2-from-external-usb-storage-using-raspbian.html">Pi 2 Model B + Raspbian</a></li>
<li>v2.0 - <a class="reference external" href="http://www.circuidipity.com/run-a-raspberry-pi-2-from-external-usb-storage.html">Pi 2 Model B + Ubuntu</a></li>
<li>v1.0 - <a class="reference external" href="http://www.circuidipity.com/run-a-raspberry-pi-from-external-usb-storage.html">Pi Model B + Raspbian</a></li>
</ul>
</div>
<div class="section" id="debian">
<h2>0. Debian</h2>
<p>With the move to ARMv7 the Pi 2 is now capable of running the official Debian <strong>armhf</strong> port. Debian developer Sjoerd Simons has created a <a class="reference external" href="http://sjoerd.luon.net/posts/2015/02/debian-jessie-on-rpi2/">Jessie minimal image</a> with an updated 3.18 Linux kernel and firmware suitable for Pi 2.</p>
<p>Start here: <a class="reference external" href="http://www.circuidipity.com/debian-jessie-raspberry-pi-2.html">Install and configure Jessie on a microSD</a></p>
</div>
<div class="section" id="partition">
<h2>1. Partition</h2>
<p>I connect the USB drive to Pi and confirm detection:</p>
<div class="highlight"><pre><span class="c1"># lsblk</span>
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda           8:0    <span class="m">0</span> 931.5G  <span class="m">0</span> disk
└─sda1        8:1    <span class="m">0</span> 931.5G  <span class="m">0</span> part
mmcblk0     179:0    <span class="m">0</span>   7.6G  <span class="m">0</span> disk
├─mmcblk0p1 179:1    <span class="m">0</span>   121M  <span class="m">0</span> part /boot/firmware
└─mmcblk0p2 179:2    <span class="m">0</span>   2.9G  <span class="m">0</span> part /
</pre></div>
<p>Device is <tt class="docutils literal">sda</tt> with a single <tt class="docutils literal">sda1</tt> partition. Use <tt class="docutils literal">fdisk</tt> to create 3 new partitions on the USB drive:</p>
<ul class="simple">
<li>sda1 - 20GB - future <tt class="docutils literal">root</tt></li>
<li>sda2 - 2GB - future encrypted <tt class="docutils literal">swap</tt></li>
<li>sda3 - remaining space - future encrypted <tt class="docutils literal">storage</tt></li>
</ul>
<p>Sample walk-through:</p>
<div class="highlight"><pre><span class="c1"># fdisk /dev/sda</span>

Welcome to fdisk <span class="o">(</span>util-linux 2.25.2<span class="o">)</span>.
Changes will remain in memory only, <span class="k">until</span> you decide to write them.
Be careful before using the write command.


Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: p
Disk /dev/sda: 931.5 GiB, <span class="m">1000204886016</span> bytes, <span class="m">1953525168</span> sectors
Units: sectors of <span class="m">1</span> * <span class="nv">512</span> <span class="o">=</span> <span class="m">512</span> bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
Disklabel type: dos
Disk identifier: 0x00000000

Device     Boot Start        End    Sectors   Size Id Type
/dev/sda1        <span class="m">2048</span> <span class="m">1953525167</span> <span class="m">1953523120</span> 931.5G <span class="m">83</span> Linux


Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: d
Selected partition 1
Partition <span class="m">1</span> has been deleted.

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: n
Partition <span class="nb">type</span>
    p   primary <span class="o">(</span><span class="m">0</span> primary, <span class="m">0</span> extended, <span class="m">4</span> free<span class="o">)</span>
    e   extended <span class="o">(</span>container <span class="k">for</span> logical partitions<span class="o">)</span>
Select <span class="o">(</span>default p<span class="o">)</span>: p
Partition number <span class="o">(</span>1-4, default 1<span class="o">)</span>:
First sector <span class="o">(</span>2048-1953525167, default 2048<span class="o">)</span>:
Last sector, +sectors or +size<span class="o">{</span>K,M,G,T,P<span class="o">}</span> <span class="o">(</span>2048-1953525167, default 1953525167<span class="o">)</span>: +20G

Created a new partition <span class="m">1</span> of <span class="nb">type</span> <span class="s1">&#39;Linux&#39;</span> and of size <span class="m">20</span> GiB.

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: n
Partition <span class="nb">type</span>
    p   primary <span class="o">(</span><span class="m">1</span> primary, <span class="m">0</span> extended, <span class="m">3</span> free<span class="o">)</span>
    e   extended <span class="o">(</span>container <span class="k">for</span> logical partitions<span class="o">)</span>
Select <span class="o">(</span>default p<span class="o">)</span>: p
Partition number <span class="o">(</span>2-4, default 2<span class="o">)</span>:
First sector <span class="o">(</span>41945088-1953525167, default 41945088<span class="o">)</span>:
Last sector, +sectors or +size<span class="o">{</span>K,M,G,T,P<span class="o">}</span> <span class="o">(</span>41945088-1953525167, default 1953525167<span class="o">)</span>: +1G

Created a new partition <span class="m">2</span> of <span class="nb">type</span> <span class="s1">&#39;Linux&#39;</span> and of size <span class="m">1</span> GiB.

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: n
Partition <span class="nb">type</span>
    p   primary <span class="o">(</span><span class="m">2</span> primary, <span class="m">0</span> extended, <span class="m">2</span> free<span class="o">)</span>
    e   extended <span class="o">(</span>container <span class="k">for</span> logical partitions<span class="o">)</span>
Select <span class="o">(</span>default p<span class="o">)</span>: p
Partition number <span class="o">(</span>3,4, default 3<span class="o">)</span>:
First sector <span class="o">(</span>44042240-1953525167, default 44042240<span class="o">)</span>:
Last sector, +sectors or +size<span class="o">{</span>K,M,G,T,P<span class="o">}</span> <span class="o">(</span>44042240-1953525167, default 1953525167<span class="o">)</span>:

Created a new partition <span class="m">3</span> of <span class="nb">type</span> <span class="s1">&#39;Linux&#39;</span> and of size 910.5 GiB.

Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: p
Disk /dev/sda: 931.5 GiB, <span class="m">1000204886016</span> bytes, <span class="m">1953525168</span> sectors
Units: sectors of <span class="m">1</span> * <span class="nv">512</span> <span class="o">=</span> <span class="m">512</span> bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: <span class="m">512</span> bytes / <span class="m">512</span> bytes
Disklabel type: dos
Disk identifier: 0x00000000

Device     Boot    Start        End    Sectors   Size Id Type
/dev/sda1           <span class="m">2048</span>   <span class="m">41945087</span>   <span class="m">41943040</span>    20G <span class="m">83</span> Linux
/dev/sda2       <span class="m">41945088</span>   <span class="m">44042239</span>    <span class="m">2097152</span>     1G <span class="m">83</span> Linux
/dev/sda3       <span class="m">44042240</span> <span class="m">1953525167</span> <span class="m">1909482928</span> 910.5G <span class="m">83</span> Linux


Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: w
The partition table has been altered.
Calling ioctl<span class="o">()</span> to re-read partition table.
Syncing disks.

<span class="c1">#</span>
</pre></div>
</div>
<div class="section" id="root">
<h2>2. Root</h2>
<p>Format the future <tt class="docutils literal">rootfs</tt> partition using filesystem <tt class="docutils literal">ext4</tt> and mount:</p>
<div class="highlight"><pre><span class="c1"># mke2fs -t ext4 -L rootfs /dev/sda1</span>
<span class="c1"># mount -t ext4 /dev/sda1 /mnt</span>
</pre></div>
<p>Modify options in <tt class="docutils literal">/boot/firmware/cmdline.txt</tt> to point the bootloader to <tt class="docutils literal">root</tt> filesystem on the USB device:</p>
<div class="highlight"><pre>Original:
dwc_otg.lpm_enable<span class="o">=</span><span class="m">0</span> <span class="nv">console</span><span class="o">=</span>ttyAMA0,115200 <span class="nv">console</span><span class="o">=</span>tty1 <span class="nv">root</span><span class="o">=</span>/dev/mmcblk0p2 rootwait net.ifnames<span class="o">=</span>1

Modified:
dwc_otg.lpm_enable<span class="o">=</span><span class="m">0</span> <span class="nv">console</span><span class="o">=</span>ttyAMA0,115200 <span class="nv">console</span><span class="o">=</span>tty1 <span class="nv">root</span><span class="o">=</span>/dev/sda1 rootwait <span class="nv">rootdelay</span><span class="o">=</span>5
</pre></div>
<p>Comment out <tt class="docutils literal">mmcblk0p2</tt> and point to the new <tt class="docutils literal">root</tt> partition in <tt class="docutils literal">/etc/fstab</tt>:</p>
<div class="highlight"><pre><span class="c1">#/dev/mmcblk0p2  / ext4 relatime,errors=remount-ro,discard 0 1</span>
/dev/sda1 / ext4 relatime,errors<span class="o">=</span>remount-ro <span class="m">0</span> 1
/dev/mmcblk0p1 /boot/firmware vfat defaults <span class="m">0</span> 2
</pre></div>
<p>Use <tt class="docutils literal">rsync</tt> to duplicate contents of <tt class="docutils literal">root</tt> on the microSD <a class="footnote-reference" href="#id4" id="id2">[2]</a> to the <tt class="docutils literal">rootfs</tt> partition on the USB hard drive:</p>
<div class="highlight"><pre><span class="c1"># apt-get -y install rsync</span>
<span class="c1"># rsync --exclude=firmware/* -axv / /mnt</span>
</pre></div>
</div>
<div class="section" id="luks-encryption">
<h2>3. LUKS encryption</h2>
<p>Root is unencrypted to allow <strong>unattended boots</strong> of the server (otherwise the Pi would hang waiting for a passphrase that never arrives). A LUKS-encrypted <tt class="docutils literal">swap</tt> is added with a <strong>randomly-generated key</strong> and post-boot I log in and mount a LUKS-encrypted <tt class="docutils literal">storage</tt> partition using a passphrase.</p>
<div class="section" id="storage">
<h3>3.1 Storage</h3>
<p>Encrypt the partition, assign a passphrase, and format using filesystem <tt class="docutils literal">ext4</tt>:</p>
<div class="highlight"><pre><span class="c1"># apt-get -y install cryptsetup</span>
<span class="c1"># cryptsetup luksFormat /dev/sda3</span>
<span class="c1"># cryptsetup luksOpen /dev/sda3 sda3_crypt</span>
<span class="c1"># mkfs.ext4 -L storage /dev/mapper/sda3_crypt</span>
</pre></div>
<p>Create a mountpoint and mount the partition:</p>
<div class="highlight"><pre><span class="c1"># mkdir /media/sda3_crypt &amp;&amp; mount -t ext4 /dev/mapper/sda3_crypt /media/sda3_crypt/</span>
</pre></div>
<p>Unmounting:</p>
<div class="highlight"><pre><span class="c1"># umount /media/sda3_crypt &amp;&amp; cryptsetup luksClose /dev/mapper/sda3_crypt</span>
</pre></div>
</div>
<div class="section" id="swap">
<h3>3.2 Swap</h3>
<p>Configure the secure wiping of the swap partition, auto-generation of a new random key, and swap activation at boot:</p>
<div class="highlight"><pre><span class="c1"># echo &quot;sda2_crypt /dev/sda2 /dev/urandom cipher=aes-xts-plain64,size=256,swap&quot; &gt;&gt; /etc/crypttab</span>
<span class="c1"># echo &quot;/dev/mapper/sda2_crypt none swap sw 0 0&quot; &gt;&gt; /etc/fstab</span>
</pre></div>
</div>
</div>
<div class="section" id="reboot">
<h2>4. Reboot</h2>
<p>Aaaand reboot!</p>
<div class="highlight"><pre><span class="c1"># reboot</span>
</pre></div>
<p>Log in and check the new filesystem layout:</p>
<div class="highlight"><pre>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root        20G  646M   18G   4% /
devtmpfs        459M     <span class="m">0</span>  459M   0% /dev
tmpfs           463M     <span class="m">0</span>  463M   0% /dev/shm
tmpfs           463M  340K  463M   1% /run
tmpfs           5.0M     <span class="m">0</span>  5.0M   0% /run/lock
tmpfs           463M     <span class="m">0</span>  463M   0% /sys/fs/cgroup
/dev/mmcblk0p1  121M  9.7M  112M   9% /boot/firmware
</pre></div>
</div>
<div class="section" id="static-address">
<h2>5. Static Address</h2>
<p>Assign a Pi home server a <strong>static network address</strong>. Sample <tt class="docutils literal">/etc/network/interfaces</tt> that disables <tt class="docutils literal">dhcp</tt>, sets ip address <tt class="docutils literal">192.168.1.88</tt>, and connects to a router (managing DNS) at <tt class="docutils literal">192.168.1.1</tt>:</p>
<div class="highlight"><pre>auto eth0
iface eth0 inet static
    address 192.168.1.88
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 192.168.1.1
</pre></div>
<p>Happy hacking!</p>
<div class="section" id="notes">
<h3>Notes</h3>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://www.raspberrypi.org/forums/viewtopic.php?f=29&amp;t=44177">Discussion thread (raspberrypi.org/forums)</a> about moving root to external USB storage.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Raspberry Pi requires an SD card to boot and the bootloader expects certain config files to reside on a <tt class="docutils literal">vfat</tt> formatted partition. This particular Debian <tt class="docutils literal"><span class="pre">jessie-rpi2-DATE.img</span></tt> installs the necessary files in <tt class="docutils literal">mmcblk0p1</tt> and mounts this partition to <tt class="docutils literal">/boot/firmware</tt>. You can inspect the image partition layout, contents, and make modifications before installing to a microSD: <a class="reference external" href="https://raspberrypi.stackexchange.com/questions/13137/how-can-i-mount-a-raspberry-pi-linux-distro-image">How can I mount a Raspberry Pi linux distro image?</a></td></tr>
</tbody>
</table>
</div>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-raspberry-pi.html">raspberry pi</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-debian.html">debian</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-luks.html">luks</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-crypto.html">crypto</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-network.html">network</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/debian-jessie-raspberry-pi-2.html">Debian Jessie on Raspberry Pi 2</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/raspberry-pi-ram-irqbalance.html">Raspberry Pi RAM gobbled up by irqbalance</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2015 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>