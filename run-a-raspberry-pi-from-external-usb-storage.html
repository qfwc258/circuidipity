<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Run a Raspberry Pi from external USB storage</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><i class="fa fa-rocket"></i> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    <a href="archives.html">Archives</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Thursday 29 January 2015</p>
</div>

<!-- article -->
<h1>Run a Raspberry Pi from external USB storage</h1>
    <p class="modified"><i class="fa fa-wrench"></i>&nbsp; Last modified on Saturday 31 January 2015</p>
<div id="article">
    <p><a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">Raspberry Pi Home Server Hack #0 &gt;&gt;</a> I am exploring the use of my Raspberry Pi as a 24/7 uptime <a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">home server</a>, and one of the hacks I wish to add is using Pi as a cheap and cheerful <strong>network attached storage</strong> (NAS) device. Hmmm... How about using that USB hard drive I connect for NAS and move over the Pi root filesystem and run it from there as well? I imagine an always-on Pi would enjoy more robust performance from a hard drive than an SD card.</p>
<p>Thanks to all the contributors <a class="reference external" href="http://www.raspberrypi.org/forums/viewtopic.php?f=29&amp;t=44177">on this discussion thread</a> I put my plan in motion using:</p>
<ul class="simple">
<li>Raspberry Pi Model B</li>
<li>5V 1A microUSB power adapter</li>
<li>ethernet cable</li>
<li>Raspbian Linux</li>
<li>SD card (for /boot)</li>
<li>1TB powered USB hard drive</li>
</ul>
<div class="section" id="let-s-go">
<h2>Let's go!</h2>
<div class="section" id="raspbian-linux">
<h3>0. Raspbian Linux</h3>
<p><a class="reference external" href="http://downloads.raspberrypi.org/raspbian_latest">Download</a> and unpack Raspbian and write the image to a spare 4GB+ SD card:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo dd <span class="nv">bs</span><span class="o">=</span>1M <span class="k">if</span><span class="o">=</span>YYYY-MM-DD-wheezy-raspbian.img <span class="nv">of</span><span class="o">=</span>/dev/sdX
<span class="nv">$ </span>sudo sync
</pre></div>
<p>Sources: <a class="reference external" href="http://www.raspberrypi.org/downloads/">operating system images</a>, installing <a class="reference external" href="http://www.raspberrypi.org/documentation/installation/installing-images/linux.md">images on Linux</a></p>
</div>
<div class="section" id="raspi-config">
<h3>1. Raspi-config</h3>
<p>Boot the Pi with the newly-minted Raspbian SD card and set a few options in the <strong>raspi-config</strong> utility:</p>
<div class="highlight"><pre>4 Internationalisation Options
    * Change Locale
    * Change Timezone
8 Advanced Options
    * Hostname
    * Memory Split  <span class="c"># default is GPU=64MB, for a headless server set GPU=16MB and free more memory for the CPU</span>
    * SSH           <span class="c"># enable SSH server at boot to permit login to Pi over LAN</span>
</pre></div>
<p>Save the new parameters and reboot.</p>
</div>
<div class="section" id="partitions">
<h3>2. Partitions</h3>
<p>Filesystem layout on the SD card:</p>
<div class="highlight"><pre><span class="nv">$ </span>df -h
Filesystem      Size  Used Avail Use% Mounted on
rootfs          2.9G  2.4G  401M  86% /
/dev/root       2.9G  2.4G  401M  86% /
devtmpfs        239M     0  239M   0% /dev
tmpfs            49M  232K   49M   1% /run
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs            97M     0   97M   0% /run/shm
/dev/mmcblk0p1   56M  9.7M   47M  18% /boot
</pre></div>
<p>I connect my 1TB USB drive to Pi and confirm device detection:</p>
<div class="highlight"><pre><span class="nv">$ </span>lsusb
Bus 001 Device 002: ID 0424:9514 Standard Microsystems Corp.
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 003: ID 0424:ec00 Standard Microsystems Corp.
Bus 001 Device 005: ID 152d:2329 JMicron Technology Corp. / JMicron USA Technology Corp. JM20329 SATA Bridge
<span class="nv">$ </span>dmesg
<span class="o">[</span> ... <span class="o">]</span>
<span class="o">[</span> 1000.758503<span class="o">]</span> usb 1-1.3: new high-speed USB device number 5 using dwc_otg
<span class="o">[</span> 1000.879972<span class="o">]</span> usb 1-1.3: New USB device found, <span class="nv">idVendor</span><span class="o">=</span>152d, <span class="nv">idProduct</span><span class="o">=</span>2329
<span class="o">[</span> 1000.880010<span class="o">]</span> usb 1-1.3: New USB device strings: <span class="nv">Mfr</span><span class="o">=</span>1, <span class="nv">Product</span><span class="o">=</span>2, <span class="nv">SerialNumber</span><span class="o">=</span>5
<span class="o">[</span> 1000.880026<span class="o">]</span> usb 1-1.3: Product: USB to ATA/ATAPI bridge
<span class="o">[</span> 1000.880043<span class="o">]</span> usb 1-1.3: Manufacturer: JMicron
<span class="o">[</span> 1000.880057<span class="o">]</span> usb 1-1.3: SerialNumber: DCA5968053FF
<span class="o">[</span> 1000.887271<span class="o">]</span> usb-storage 1-1.3:1.0: USB Mass Storage device detected
<span class="o">[</span> 1000.892548<span class="o">]</span> usb-storage 1-1.3:1.0: Quirks match <span class="k">for </span>vid 152d pid 2329: 8020
<span class="o">[</span> 1000.892761<span class="o">]</span> scsi0 : usb-storage 1-1.3:1.0
<span class="o">[</span> 1001.928635<span class="o">]</span> scsi 0:0:0:0: Direct-Access     WDC WD10 EARS-00Y5B1           PQ: 0 ANSI: 2 CCS
<span class="o">[</span> 1001.932571<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> 1953525168 512-byte logical blocks: <span class="o">(</span>1.00 TB/931 GiB<span class="o">)</span>
<span class="o">[</span> 1001.933328<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Write Protect is off
<span class="o">[</span> 1001.933365<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Mode Sense: 28 00 00 00
<span class="o">[</span> 1001.934066<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> No Caching mode page found
<span class="o">[</span> 1001.934096<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Assuming drive cache: write through
<span class="o">[</span> 1001.936947<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> No Caching mode page found
<span class="o">[</span> 1001.936984<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Assuming drive cache: write through
<span class="o">[</span> 1001.984646<span class="o">]</span> sd 0:0:0:0: Attached scsi generic sg0 <span class="nb">type </span>0
<span class="o">[</span> 1002.344655<span class="o">]</span>  sda: sda1
<span class="o">[</span> 1002.365186<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> No Caching mode page found
<span class="o">[</span> 1002.365227<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Assuming drive cache: write through
<span class="o">[</span> 1002.365255<span class="o">]</span> sd 0:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Attached SCSI disk
</pre></div>
<p>Device is <tt class="docutils literal">sda</tt>. Use <strong>fdisk</strong> to create 2 new partitions on the USB drive:</p>
<ul class="simple">
<li>sda1 - 20GB - Pi root filesystem</li>
<li>sda2 - remaining space - file storage</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>sudo fdisk /dev/sda

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: p

Disk /dev/sda: 1000.2 GB, 1000204886016 bytes
255 heads, 63 sectors/track, 121601 cylinders, total 1953525168 sectors
<span class="nv">Units</span> <span class="o">=</span> sectors of 1 * <span class="nv">512</span> <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disk identifier: 0x00000000

Device Boot      Start         End      Blocks   Id  System

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: n
Partition <span class="nb">type</span>:
  p   primary <span class="o">(</span>0 primary, 0 extended, 4 free<span class="o">)</span>
  e   extended
Select <span class="o">(</span>default p<span class="o">)</span>: p
Partition number <span class="o">(</span>1-4, default 1<span class="o">)</span>:
Using default value 1
First sector <span class="o">(</span>2048-1953525167, default 2048<span class="o">)</span>:
Using default value 2048
Last sector, +sectors or +size<span class="o">{</span>K,M,G<span class="o">}</span> <span class="o">(</span>2048-1953525167, default 1953525167<span class="o">)</span>: +20G

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: n
Partition <span class="nb">type</span>:
  p   primary <span class="o">(</span>1 primary, 0 extended, 3 free<span class="o">)</span>
  e   extended
Select <span class="o">(</span>default p<span class="o">)</span>: p
Partition number <span class="o">(</span>1-4, default 2<span class="o">)</span>:
Using default value 2
First sector <span class="o">(</span>41945088-1953525167, default 41945088<span class="o">)</span>:
Using default value 41945088
Last sector, +sectors or +size<span class="o">{</span>K,M,G<span class="o">}</span> <span class="o">(</span>41945088-1953525167, default 1953525167<span class="o">)</span>:
Using default value 1953525167

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: p

Disk /dev/sda: 1000.2 GB, 1000204886016 bytes
255 heads, 63 sectors/track, 121601 cylinders, total 1953525168 sectors
<span class="nv">Units</span> <span class="o">=</span> sectors of 1 * <span class="nv">512</span> <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disk identifier: 0x00000000

Device Boot      Start         End      Blocks   Id  System
/dev/sda1            2048    41945087    20971520   83  Linux
/dev/sda2        41945088  1953525167   955790040   83  Linux

Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: w
The partition table has been altered!

Calling ioctl<span class="o">()</span> to re-read partition table.
Syncing disks.
</pre></div>
</div>
<div class="section" id="filesystems">
<h3>3. Filesystems</h3>
<p>Format the new partitions as <tt class="docutils literal">ext4</tt>:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo mke2fs -t ext4 -L rootfs /dev/sda1
<span class="nv">$ </span>sudo mke2fs -t ext4 -L storage /dev/sda2
</pre></div>
</div>
<div class="section" id="dev-root">
<h3>4. /dev/root</h3>
<p>Mount the newly-formatted <tt class="docutils literal">rootfs</tt> partition to <tt class="docutils literal">/mnt</tt>:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo mount -t ext4 /dev/sda1 /mnt
<span class="nv">$ </span>df -h
Filesystem      Size  Used Avail Use% Mounted on
rootfs          2.9G  2.4G  401M  86% /
/dev/root       2.9G  2.4G  401M  86% /
devtmpfs        239M     0  239M   0% /dev
tmpfs            49M  220K   49M   1% /run
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs            97M     0   97M   0% /run/shm
/dev/mmcblk0p1   56M  9.7M   47M  18% /boot
/dev/sda1        20G   44M   19G   1% /mnt
</pre></div>
<p>Use <strong>rsync</strong> to copy contents of <tt class="docutils literal">root</tt> on the SD card to the <tt class="docutils literal">rootfs</tt> partition on the USB device:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo rsync -axv / /mnt
</pre></div>
</div>
<div class="section" id="new-rootfs">
<h3>5. New rootfs</h3>
<p>Modify options in <tt class="docutils literal">/boot/cmdline.txt</tt> - located on the <strong>SD card</strong> - to point the bootloader to <tt class="docutils literal">root</tt> filesystem on the USB device:</p>
<div class="highlight"><pre>Original:
dwc_otg.lpm_enable<span class="o">=</span>0 <span class="nv">console</span><span class="o">=</span>ttyAMA0,115200 <span class="nv">console</span><span class="o">=</span>tty1 <span class="nv">root</span><span class="o">=</span>/dev/mmcblk0p2 <span class="nv">rootfstype</span><span class="o">=</span>ext4 <span class="nv">elevator</span><span class="o">=</span>deadline rootwait

Modified:
dwc_otg.lpm_enable<span class="o">=</span>0 <span class="nv">console</span><span class="o">=</span>ttyAMA0,115200 <span class="nv">console</span><span class="o">=</span>tty1 <span class="nv">root</span><span class="o">=</span>/dev/sda1 <span class="nv">rootfstype</span><span class="o">=</span>ext4 <span class="nv">elevator</span><span class="o">=</span>deadline rootwait <span class="nv">rootdelay</span><span class="o">=</span>5
</pre></div>
</div>
<div class="section" id="fstab">
<h3>6. fstab</h3>
<p>Create new mountpoint for the <tt class="docutils literal">storage</tt> partition:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo mkdir /media/USB0
</pre></div>
<p>Modify options in <tt class="docutils literal">/mnt/etc/fstab</tt> - located on the <strong>USB device</strong> - to mount <tt class="docutils literal">rootfs</tt> and <tt class="docutils literal">storage</tt> partitions <a class="footnote-reference" href="#id2" id="id1">[1]</a> at boot. Sample configuration for <tt class="docutils literal">sda1</tt> and <tt class="docutils literal">sda2</tt>:</p>
<div class="highlight"><pre>proc            /proc           proc    defaults          0       0
/dev/mmcblk0p1  /boot           vfat    defaults          0       2
<span class="c"># partitions on USB</span>
/dev/sda1   /       ext4    defaults,noatime  0       1
/dev/sda2   /media/USB0  ext4    defaults,noatime  0       0
<span class="c"># comment out root filesystem on SD card</span>
<span class="c">#/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1</span>
<span class="c"># a swapfile is not a swap partition, so no using swapon|off from here on, use  dphys-swapfile swap[on|off]  for that</span>
</pre></div>
</div>
<div class="section" id="reboot">
<h3>7. Reboot</h3>
<p>Save modifications and reboot. Login and check the new filesystem layout:</p>
<div class="highlight"><pre><span class="nv">$ </span>df -h
Filesystem     Type      Size  Used Avail Use% Mounted on
rootfs         rootfs     20G  2.6G   16G  15% /
/dev/root      ext4       20G  2.6G   16G  15% /
devtmpfs       devtmpfs  239M     0  239M   0% /dev
tmpfs          tmpfs      49M  236K   49M   1% /run
tmpfs          tmpfs     5.0M     0  5.0M   0% /run/lock
tmpfs          tmpfs      97M     0   97M   0% /run/shm
/dev/mmcblk0p1 vfat       56M  9.7M   47M  18% /boot
/dev/sda2      ext4      898G  343G  510G  41% /media/USB0
</pre></div>
</div>
<div class="section" id="post-install">
<h3>8. Post-install</h3>
<div class="section" id="password">
<h4>8.1 Password</h4>
<p>A <tt class="docutils literal">raspberry</tt> is a tasty fruit but a lousy password. Change password for username <tt class="docutils literal">pi</tt>:</p>
<div class="highlight"><pre><span class="nv">$ </span>passwd
</pre></div>
</div>
<div class="section" id="sudo">
<h4>8.2 Sudo</h4>
<p>Default setting in Raspbian is to allow <tt class="docutils literal">pi</tt> to use <tt class="docutils literal">sudo</tt> without prompting for a password. Disable password-less <tt class="docutils literal">sudo</tt> by running:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo visudo -s
</pre></div>
<p>... and comment out the <tt class="docutils literal">NOPASSWD</tt> entry:</p>
<div class="highlight"><pre><span class="c">#includedir /etc/sudoers.d</span>
<span class="c">#pi ALL=(ALL) NOPASSWD: ALL</span>
</pre></div>
</div>
<div class="section" id="upgrade">
<h4>8.3 Upgrade</h4>
<p>With the newly-configured <tt class="docutils literal">rootfs</tt> up-and-running now is a good time to update Raspbian:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo apt-get update
<span class="nv">$ </span>sudo apt-get dist-upgrade
</pre></div>
</div>
<div class="section" id="static-address">
<h4>8.4 Static Address</h4>
<p>A Raspberry Pi that is going to stay home and run as a server can be configured to use a <strong>static network address</strong>. Sample <tt class="docutils literal">/etc/network/interfaces</tt> modification that disables <tt class="docutils literal">dhcp</tt> and sets ip address <tt class="docutils literal">192.168.1.88</tt>:</p>
<div class="highlight"><pre><span class="c">#iface eth0 inet dhcp</span>
auto eth0
iface eth0 inet static
    address 192.168.1.88
    netmask 255.255.255.0
    gateway 192.168.1.1
</pre></div>
<p>Happy hacking!</p>
</div>
</div>
<div class="section" id="notes">
<h3>Notes</h3>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Pi requires an SD card to boot... so we continue using original /boot.</td></tr>
</tbody>
</table>
</div>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-raspberry-pi.html">raspberry pi</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-raspbian.html">raspbian</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-networks.html">networks</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/20141218.html">Links of interest</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/raspberry-pi-home-server.html">There's no place like [a Raspberry Pi] Home [Server]</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2015 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>