<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Install Debian using grml-debootstrap</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
        <!-- analytics -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89591498-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><img class="minime" src="/theme/images/minime.png" alt="Mini Me" height="38" width="38" /> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Tuesday 08 April 2014</p>
</div>

<!-- article -->
<h1>Install Debian using grml-debootstrap</h1>
    <p class="modified"><i class="fa fa-wrench"></i>&nbsp; Last modified on Friday 22 August 2014</p>
<div id="article">
    <p><a class="reference external" href="http://grml.org/">Grml</a> is a Debian-based Linux distribution optimized for running off USB sticks and taking care of sysadmin duties. One of its cool programs that I have been exploring is <a class="reference external" href="http://grml.org/grml-debootstrap/">grml-debootstrap</a> ... a console application that makes it very easy to set custom options and install Debian.</p>
<p>Here is a step-by-step process using grml-debootstrap to implement the following sample Debian minimal install on the 16GB solid-state drive (SSD) of my <strong>Acer C720 Chromebook</strong>:</p>
<ul class="simple">
<li>create encrypted root + swap</li>
<li>install Debian <tt class="docutils literal">wheezy/stable</tt></li>
<li>upgrade to Debian <tt class="docutils literal">sid/unstable</tt> rolling release</li>
<li>configure <a class="reference external" href="https://wiki.archlinux.org/index.php/Solid_State_Drives">TRIM</a> on the SSD to maximize performance</li>
</ul>
<p>Source: Debian installation with <a class="reference external" href="http://michael-prokop.at/blog/2014/02/28/state-of-the-art-debianwheezy-deployments-with-grub-and-lvmsw-raidcrypto/">GRUB2 + GPT + LUKS crypto</a> (michael-prokop.at/blog)</p>
<div class="section" id="prepare-usb-boot-device">
<h2>0. Prepare USB boot device</h2>
<p><a class="reference external" href="http://grml.org/download/">Download</a> an installer image (I selected the 32+64bit <strong>grml96</strong> combo) and simply <tt class="docutils literal">dd</tt> the image to a spare USB device.</p>
<p>An alternate, more flexible approach (does not take over the entire drive) is <a class="reference external" href="http://www.circuidipity.com/multi-boot-usb.html">transforming a USB stick into a GRUB boot device</a> then adding the grml ISO as a menu entry that can co-exist with <a class="reference external" href="http://www.circuidipity.com/grubs.html">multiple Linux distros</a>.</p>
</div>
<div class="section" id="boot-network-and-partitions">
<h2>1. Boot, network and partitions</h2>
<p>Boot Grml with the <tt class="docutils literal">toram</tt> option <tt class="docutils literal"><span class="pre">grml64-full</span> - advanced options <span class="pre">-&gt;</span> copy Grml to RAM</tt>. This way we can make use of the USB boot device as storage for any extra packages or scripts we might want to use on the new Debian system.</p>
<p>Use the <tt class="docutils literal"><span class="pre">grml-network</span></tt> command to launch an interactive configuration of network interfaces. A sample entry generated for wifi in <tt class="docutils literal">/etc/network/interfaces</tt>:</p>
<div class="highlight"><pre><span></span>iface wlan0 inet dhcp
    wireless-mode auto
    wireless-essid YOUR_SSID
    wpa-ssid YOUR_SSID
    wpa-psk YOUR_PASSWORD
</pre></div>
<p>A sample <strong>GUID Partition Table</strong> (GPT) layout:</p>
<ul class="simple">
<li>sda1 - BIOS boot partition - 2MB</li>
<li>sda2 - boot - 200MB</li>
<li>sda3 - swap - 1GB</li>
<li>sda4 - root - remaining space</li>
</ul>
<p>Create the above using <tt class="docutils literal">parted</tt> (note: any changes are <strong>executed instantly</strong>):</p>
<div class="highlight"><pre><span></span>parted -a optimal /dev/sda
print
mklabel gpt
unit mib
mkpart primary <span class="m">1</span> 3
name <span class="m">1</span> grub
<span class="nb">set</span> <span class="m">1</span> bios_grub on
mkpart primary <span class="m">3</span> 203
name <span class="m">2</span> boot
mkpart primary <span class="m">203</span> 1203
name <span class="m">3</span> swap
mkpart primary <span class="m">1203</span> -1
name <span class="m">4</span> root
print
quit
</pre></div>
<p>To verify that a partition is properly aligned query it using <tt class="docutils literal">blockdev</tt> ('0' return = aligned):</p>
<div class="highlight"><pre><span></span>blockdev --getalignoff /dev/sdaX
0
</pre></div>
<p>Sources: <a class="reference external" href="http://git.grml.org/?p=grml-live.git;a=blob_plain;f=templates/GRML/grml-cheatcodes.txt;hb=HEAD">Grml boot cheatcodes</a> (git.grml.org), the <a class="reference external" href="https://www.gnu.org/software/grub/manual/html_node/BIOS-installation.html">BIOS Boot Partition</a> (gnu.org), and <a class="reference external" href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=4">partitioning disks using parted</a> (gentoo.org)</p>
</div>
<div class="section" id="cryptsetup">
<h2>2. Cryptsetup</h2>
<p>Configure the newly-created root partition for encrypted storage and create filesystems for <tt class="docutils literal">boot</tt> and <tt class="docutils literal"><span class="pre">crypt-root</span></tt>:</p>
<div class="highlight"><pre><span></span>cryptsetup luksFormat -c aes-xts-plain64 -s <span class="m">256</span> /dev/sda4
cryptsetup luksOpen /dev/sda4 crypt_root
mkfs.ext4 /dev/sda2
mkfs.ext4 /dev/mapper/crypt_root
</pre></div>
</div>
<div class="section" id="install-debian">
<h2>3. Install Debian</h2>
<p>Any extra packages to be installed can be added to the list in <tt class="docutils literal">/etc/debootstrap/packages</tt> and scripts to customize the setup can be placed in <tt class="docutils literal"><span class="pre">/etc/debootstrap/chroot-scripts/</span></tt>.</p>
<p><strong>Tip:</strong> If configuring a device that only has a wireless interface (Chromebook) add the <tt class="docutils literal"><span class="pre">wireless-tools</span></tt> and <tt class="docutils literal">wpasupplicant</tt> packages to the install list.</p>
<p>GRML auto-detects the <tt class="docutils literal">crypt_root</tt>, updating <tt class="docutils literal">fstab</tt> and creating a mountpoint for the device in <tt class="docutils literal">/media</tt>. Mount the newly-created partitions and install a minimal Debian setup:</p>
<div class="highlight"><pre><span></span>mount /media/crypt_root
mkdir /media/crypt_root/boot
mount -t ext4 /dev/sda2 /media/crypt_root/boot
<span class="c1"># optional: with &#39;toram&#39; usb stick can be mounted to /media... check /etc/fstab for auto-generated entries</span>
grml-debootstrap --target /media/crypt_root --password <span class="s2">&quot;PASSWORD&quot;</span> --hostname HOSTNAME
</pre></div>
<p>If <tt class="docutils literal"><span class="pre">grml-debootstrap</span></tt> is run with no options a limited interactive menu is provided ... otherwise the necessary Debian packages are downloaded and system setup runs unattended to completion.</p>
<p>Source: <a class="reference external" href="http://grml.org/grml-debootstrap/">grml-debootstrap HOWTO</a> (grml.org)</p>
</div>
<div class="section" id="adjust-crypttab-fstab-initramfs">
<h2>4. Adjust crypttab, fstab, initramfs</h2>
<p>Next step is to enter <tt class="docutils literal">chroot</tt> and perform post-install configuration:</p>
<div class="highlight"><pre><span></span>grml-chroot /media/crypt_root /bin/bash
grub-install /dev/sda
update-grub
<span class="c1"># For SSD add the &#39;discard&#39; option</span>
<span class="nb">echo</span> <span class="s2">&quot;crypt_root /dev/sda4 none luks,discard&quot;</span> &gt;&gt; /etc/crypttab
<span class="nb">echo</span> <span class="s2">&quot;crypt_swap /dev/sda3 /dev/urandom cipher=aes-xts-plain64,size=256,discard,swap&quot;</span> &gt;&gt; /etc/crypttab
<span class="nb">echo</span> <span class="s2">&quot;/dev/mapper/crypt_root / ext4 noatime,discard,errors=remount-ro 0 1&quot;</span> &gt; /etc/fstab
<span class="nb">echo</span> <span class="s2">&quot;/dev/sda2 /boot ext4 noatime,discard 0 2&quot;</span> &gt;&gt; /etc/fstab
<span class="nb">echo</span> <span class="s2">&quot;/dev/mapper/crypt_swap none swap sw,discard 0 0&quot;</span> &gt;&gt; /etc/fstab
update-initramfs -u -k all
</pre></div>
<p>Source: <a class="reference external" href="http://www.linuxjournal.com/content/solid-state-drives-get-one-already">TRIM configuration on solid-state drives</a> (linuxjournal.com)</p>
</div>
<div class="section" id="sid-swappiness-locales-and-timezone">
<h2>5. Sid, swappiness, locales, and timezone</h2>
<p>It is possible to use grml-debootstrap to directly install a Debian <tt class="docutils literal">sid/unstable</tt> setup. But I have experienced greater success by first installing a minimal stable system before doing a dist-upgrade to track the unstable rolling release.</p>
<p><strong>Optional:</strong> Continue inside <tt class="docutils literal">chroot</tt> and upgrade to <tt class="docutils literal">unstable</tt> by modifying <tt class="docutils literal">/etc/apt/sources.list</tt>:</p>
<div class="highlight"><pre><span></span><span class="c1">### unstable ###</span>
deb http://http.debian.net/debian unstable main contrib non-free
deb-src http://http.debian.net/debian unstable main contrib non-free
</pre></div>
<p>Run <tt class="docutils literal"><span class="pre">apt-get</span> update &amp;&amp; <span class="pre">apt-get</span> <span class="pre">dist-upgrade</span></tt></p>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Swappiness">swappiness</a> parameter controls the preference of the kernel to move processes out of physical memory to the swap partition. Range is 0-100, default is set to 60 and lower values cause the kernel to avoid swapping and higher values prompt more frequent swap use.</p>
<p>To reduce writes on the SSD set a low value of '1':</p>
<div class="highlight"><pre><span></span><span class="c1"># check current swappiness value</span>
cat /proc/sys/vm/swappiness
<span class="c1"># temporarily change value</span>
/sbin/sysctl vm.swappiness<span class="o">=</span>1
<span class="c1"># permanently change value... modify &#39;vm.swappiness&#39; value in /etc/sysctl.conf...</span>
vm.swappiness<span class="o">=</span>1
</pre></div>
<p>Configure the system environment for your local language and timezone using <tt class="docutils literal"><span class="pre">dpkg-reconfigure</span> locales</tt> and <tt class="docutils literal"><span class="pre">dpkg-reconfigure</span> tzdata</tt>.</p>
</div>
<div class="section" id="reboot">
<h2>6. Reboot</h2>
<p>Exit the chroot, unmount partitions, and reboot into Debian:</p>
<div class="highlight"><pre><span></span><span class="nb">exit</span>
umount /media/crypt_root/boot
umount /media/crypt_root
cryptsetup luksClose /dev/mapper/crypt_root
reboot
</pre></div>
<p>Happy hacking!</p>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-debian.html">debian</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-chromebook.html">chromebook</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/youtube-dl.html">Command line tools: youtube-dl</a></p>
    <p class="nextpost">Newer <i class="fa fa-arrow-right"></i><br />
        <a href="http://www.circuidipity.com/no-udevd-no-automount.html">No udevd no auto-mount</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2016 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>