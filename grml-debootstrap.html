<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Install Debian using grml-debootstrap</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><i class="fa fa-rocket"></i> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    <a href="archives.html">Archives</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Tuesday 08 April 2014</p>
</div>

<!-- article -->
<h1>Install Debian using grml-debootstrap</h1>
<div id="article">
    <p><a class="reference external" href="http://grml.org/">Grml</a> is a Debian-based Linux distribution optimized for running off USB sticks and taking care of sysadmin duties. One of its cool programs that I have been exploring is <a class="reference external" href="http://grml.org/grml-debootstrap/">grml-debootstrap</a> ... a console application that makes it very easy to set custom options and install Debian.</p>
<p>Here is a step-by-step process using grml-debootstrap to implement the following sample installation on a solid-state drive (SSD):</p>
<ul class="simple">
<li>create encrypted root + swap</li>
<li>install Debian <em>wheezy</em> (stable)</li>
<li>upgrade to Debian <em>sid</em> (unstable) rolling release</li>
<li>configure <a class="reference external" href="https://wiki.archlinux.org/index.php/Solid_State_Drives">TRIM</a> on the SSD to maximize performance</li>
</ul>
<p>Source: Debian installation with <a class="reference external" href="http://michael-prokop.at/blog/2014/02/28/state-of-the-art-debianwheezy-deployments-with-grub-and-lvmsw-raidcrypto/">GRUB2 + GPT + LUKS crypto</a></p>
<div class="section" id="step-0-prepare-usb-boot-device">
<h2>Step 0 - Prepare USB boot device</h2>
<p><a class="reference external" href="http://grml.org/download/">Download</a> a Grml 32- or 64-bit ISO (or the 2-in-1 <strong>grml96</strong> [my choice]) and simply <tt class="docutils literal">dd</tt> the image to a spare USB device.</p>
<p>An alternate, more flexible approach (does not take over the entire drive) is <a class="reference external" href="http://www.circuidipity.com/multi-boot-usb.html">transforming a USB stick into a GRUB boot device</a> then adding the grml ISO as a menu entry that can co-exist with <a class="reference external" href="http://www.circuidipity.com/grubs.html">multiple Linux distros</a>.</p>
</div>
<div class="section" id="step-1-boot-network-and-partitions">
<h2>Step 1 - Boot, network and partitions</h2>
<p>Boot Grml with the <em>toram</em> option <tt class="docutils literal"><span class="pre">grml64-full</span> - advanced options <span class="pre">-&gt;</span> copy Grml to RAM</tt>. This way we can make use of the USB boot device as storage for any extra packages or scripts we might want to use on the new Debian system.</p>
<p>Use the <tt class="docutils literal"><span class="pre">grml-network</span></tt> command to launch an interactive configuration of network interfaces. A sample entry generated for wifi in <tt class="docutils literal">/etc/network/interfaces</tt> ...</p>
<div class="highlight"><pre>iface wlan0 inet dhcp
    wireless-mode auto
    wireless-essid MY_ROUTER
    wpa-ssid SSID
    wpa-psk PASSWORD
</pre></div>
<p>A sample <em>GUID Partition Table</em> (GPT) layout:</p>
<ul class="simple">
<li>sda1 - BIOS boot partition - 2MB</li>
<li>sda2 - boot - 200MB</li>
<li>sda3 - swap - 1GB</li>
<li>sda4 - root - remaining space</li>
</ul>
<p>Create the above using <tt class="docutils literal">parted</tt> (note: any changes are executed instantly) ...</p>
<div class="highlight"><pre>parted -a optimal /dev/sda
print
mklabel gpt
unit mib
mkpart primary 1 3
name 1 grub
<span class="nb">set </span>1 bios_grub on
mkpart primary 3 203
name 2 boot
mkpart primary 203 1203
name 3 swap
mkpart primary 1203 -1
name 4 root
print
quit
</pre></div>
<p>To verify that a partition is properly aligned query it using <tt class="docutils literal">blockdev</tt> ('0' return = aligned) ...</p>
<div class="highlight"><pre>blockdev --getalignoff /dev/&lt;partition&gt;
0
</pre></div>
<p>Sources: <a class="reference external" href="http://git.grml.org/?p=grml-live.git;a=blob_plain;f=templates/GRML/grml-cheatcodes.txt;hb=HEAD">Grml boot cheatcodes</a>, the <a class="reference external" href="https://www.gnu.org/software/grub/manual/html_node/BIOS-installation.html">BIOS Boot Partition</a>, and <a class="reference external" href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=4">partitioning disks using parted</a></p>
</div>
<div class="section" id="step-2-cryptsetup">
<h2>Step 2 - Cryptsetup</h2>
<p>Set the newly-created root partition for encrypted storage and create filesystems for <tt class="docutils literal">boot</tt> and <tt class="docutils literal"><span class="pre">crypt-root</span></tt> ...</p>
<div class="highlight"><pre><span class="nb">echo </span>cryptsetup &gt;&gt; /etc/debootstrap/packages  <span class="c"># only necessary for Grml &lt;=2013.09</span>
cryptsetup luksFormat -c aes-xts-plain64 -s 256 /dev/sda4
cryptsetup luksOpen /dev/sda4 crypt_root
mkfs.ext4 /dev/sda2
mkfs.ext4 /dev/mapper/crypt_root
</pre></div>
</div>
<div class="section" id="step-3-install-debian">
<h2>Step 3 - Install Debian</h2>
<p>Any extra packages to be installed can be added to the list in <tt class="docutils literal">/etc/debootstrap/packages</tt> and scripts to customize the setup can be placed in <tt class="docutils literal"><span class="pre">/etc/debootstrap/chroot-scripts/</span></tt>. Check out the <a class="reference external" href="http://grml.org/grml-debootstrap/">grml-debootstrap HOWTO</a> for many possible options ...</p>
<div class="highlight"><pre>mount -t ext4 /dev/mapper/crypt_root /media
mkdir /media/boot
mount -t ext4 /dev/sda2 /media/boot
<span class="c"># optional: with &#39;toram&#39; usb stick can be mounted to /media... check /etc/fstab for auto-generated entries</span>
grml-debootstrap --target /media --password <span class="s2">&quot;PASSWORD&quot;</span> --hostname HOSTNAME
</pre></div>
<p>If grml-debootstrap is run with no options a limited interactive menu is provided ... otherwise the necessary Debian packages are downloaded and system setup runs unattended to completion.</p>
</div>
<div class="section" id="step-4-adjust-crypttab-fstab-initramfs">
<h2>Step 4 - Adjust crypttab, fstab, initramfs</h2>
<p>Next step is to enter <tt class="docutils literal">chroot</tt> and perform post-install configuration ...</p>
<div class="highlight"><pre>grml-chroot /media /bin/bash
grub-install /dev/sda
update-grub
<span class="c"># For SSD add the &#39;discard&#39; option</span>
<span class="nb">echo</span> <span class="s2">&quot;crypt_root /dev/sda4 none luks,discard&quot;</span> &gt;&gt; /etc/crypttab
<span class="nb">echo</span> <span class="s2">&quot;crypt_swap /dev/sda3 /dev/urandom cipher=aes-xts-plain64,size=256,noearly,discard,swap&quot;</span> &gt;&gt; /etc/crypttab
<span class="nb">echo</span> <span class="s2">&quot;/dev/mapper/crypt_root / ext4 noatime,discard,errors=remount-ro 0 1&quot;</span> &gt; /etc/fstab
<span class="nb">echo</span> <span class="s2">&quot;/dev/sda2 /boot ext4 noatime,discard 0 2&quot;</span> &gt;&gt; /etc/fstab
<span class="nb">echo</span> <span class="s2">&quot;/dev/mapper/crypt_swap none swap sw,discard 0 0&quot;</span> &gt;&gt; /etc/fstab
update-initramfs -u -k all
</pre></div>
<p>Source: <a class="reference external" href="http://www.linuxjournal.com/content/solid-state-drives-get-one-already">TRIM configuration on solid-state drives</a></p>
</div>
<div class="section" id="step-5-sid-and-swappiness">
<h2>Step 5 - Sid and swappiness</h2>
<p>It is possible to use grml-debootstrap to directly install a <tt class="docutils literal">sid/unstable</tt> Debian setup. But I have experienced greater success by first installing a minimal <tt class="docutils literal">stable</tt> Debian system before proceeding to upgrade the system to <tt class="docutils literal">unstable</tt>.</p>
<p>Optional: Continuing configuration inside <tt class="docutils literal">chroot</tt> ... upgrade <tt class="docutils literal">wheezy</tt> to <tt class="docutils literal">sid</tt> by modifying <tt class="docutils literal">/etc/apt/sources.list</tt> ...</p>
<div class="highlight"><pre><span class="c">### unstable ###</span>
deb http://http.debian.net/debian unstable main contrib non-free
deb-src http://http.debian.net/debian unstable main contrib non-free
</pre></div>
<p>Run <tt class="docutils literal"><span class="pre">apt-get</span> update &amp;&amp; <span class="pre">apt-get</span> <span class="pre">dist-upgrade</span></tt></p>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Swappiness">swappiness</a> parameter controls the preference of the kernel to move processes out of physical memory to the swap partition. Range is 0-100, default is set to 60 and lower values cause the kernel to avoid swapping and higher values prompt more frequent swap use.</p>
<p>To reduce writes on the SSD set a low value of '1' ...</p>
<div class="highlight"><pre><span class="c"># check current swappiness value</span>
cat proc/sys/vim/swappiness
<span class="c"># temporarily change value</span>
/sbin/sysctl vm.swappiness<span class="o">=</span>1
<span class="c"># permanently change value... modify &#39;vm.swappiness&#39; value in /etc/sysctl.conf...</span>
vm.swappiness<span class="o">=</span>1
</pre></div>
</div>
<div class="section" id="step-6-reboot">
<h2>Step 6 - Reboot</h2>
<p>With everything configured to satisfaction ... exit the chroot, unmount partitions, and reboot into the new Debian system ...</p>
<div class="highlight"><pre><span class="nb">exit</span>
umount /media/boot
umount /media
cryptsetup luksClose /dev/mapper/crypt_root
reboot
</pre></div>
<p>... and enjoy!</p>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-grml.html">grml</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-debian.html">debian</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/youtube-dl.html">Download videos using youtube-dl</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <a href="/colophon.html">Colophon</a>
    <a href="/tags.html">Tags</a>
    <a href="/"><i class="fa fa-rocket"></i> Home</a><br />
    <span class="noWrap">Copyright &#169; 2014</span> and
    <a class="invisibleLink" rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
    <img alt="Creative Commons BY-NC-SA License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a>
    by <span class="noWrap"><a rel="author" href="/">Daniel Wayne Armstrong</a></span>&nbsp;
    <span class="noWrap"><i class="fa fa-globe"></i> Find me at <span class="whoa">daniel at circuidipity dot com</span></span></p>
</div></body>
</html>