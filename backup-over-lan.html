<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
        <title>Circuidipity | Automatic backups over the LAN</title>
        <meta http-equiv="content-type" content="text/html"; charset="utf-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="author" content="Daniel Wayne Armstrong" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/main.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/pygment.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/css/font.css" type="text/css" media="all" />
        <link rel="stylesheet" href="http://www.circuidipity.com/theme/images/icons/font-awesome/css/font-awesome.min.css">
        <link rel="icon" href="http://www.circuidipity.com/theme/images/favicon.ico" type="image/x-icon" />
        <!-- analytics -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89591498-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>
        <!-- content -->

<!-- breadcrumb trail -->
<div id="breadcrumb">
    <p><a href="/"><img class="minime" src="/theme/images/minime.png" alt="Mini Me" height="38" width="38" /> Howdy!</a> &nbsp;<i class="fa fa-arrow-right"></i>&nbsp;
    Friday 19 May 2017</p>
</div>

<!-- article -->
<h1>Automatic backups over the LAN</h1>
<div id="article">
    <p><a class="reference external" href="http://www.circuidipity.com/raspberry-pi-home-server.html">PROJECT: Home Server #4 .:</a> Make incremental and automatic backups of a home folder to a local server using <strong>SSH + rsync + cron</strong>.</p>
<div class="section" id="let-s-go">
<h2>Let's go!</h2>
<p><strong>Server</strong> is a <a class="reference external" href="http://www.circuidipity.com/laptop-home-server.html">raised-from-the-dead netbook</a> on the home network. <strong>Client</strong> desktop is configured to perform a daily sync of its <tt class="docutils literal">$HOME</tt> to server.</p>
<div class="section" id="server-and-client-ssh-keys">
<h3>0. Server and Client: SSH keys</h3>
<p><a class="reference external" href="http://www.circuidipity.com/secure-remote-access-using-ssh-keys.html">Create cryptographic keys and disable password logins</a> to make traffic between server and client more secure.</p>
</div>
<div class="section" id="server-backup-directory">
<h3>1. Server: backup directory</h3>
<p>Create a directory to store the backup ...</p>
<div class="highlight"><pre><span></span>$ mkdir -p /path/to/backup
</pre></div>
</div>
<div class="section" id="client-hosts-alias">
<h3>2. Client: hosts alias</h3>
<p>Set the IP address and hostname of server in <tt class="docutils literal">/etc/hosts</tt>. Sample entry ...</p>
<div class="highlight"><pre><span></span>192.168.1.88    netbook.lan
</pre></div>
</div>
<div class="section" id="client-sync">
<h3>3. Client: sync</h3>
<p>Test synching <tt class="docutils literal">$HOME/</tt> to <tt class="docutils literal"><span class="pre">netbook.lan:/path/to/backup/</span></tt> with the <tt class="docutils literal">rsync <span class="pre">--dry-run</span></tt> option. Example ...</p>
<div class="highlight"><pre><span></span>$ rsync --dry-run --archive --delete --verbose <span class="nv">$HOME</span>/ netbook.lan:/path/to/backup/
</pre></div>
<p>If everything checks out OK drop <tt class="docutils literal"><span class="pre">--dry-run</span></tt> and re-run the command to make a proper backup.</p>
</div>
<div class="section" id="client-script">
<h3>4. Client: script</h3>
<p>Start piling on the options to rsync and the command quickly becomes awkward and easy to get wrong. Option <tt class="docutils literal"><span class="pre">--delete</span></tt> is useful but can generate unpleasant surprises. A few things I <tt class="docutils literal"><span class="pre">--exclude</span></tt> from a <tt class="docutils literal">$HOME</tt> sync are <tt class="docutils literal">[Cc]ache</tt> and <tt class="docutils literal">[Tt]rash</tt> and <tt class="docutils literal">[Tt]humbnails</tt>, and pay attention to the trailing forward-slash <tt class="docutils literal">/</tt> on directories.</p>
<p>I create a shell script <tt class="docutils literal">teleportHome.sh</tt> that makes use of the <tt class="docutils literal">keychain</tt> utility to <a class="reference external" href="http://www.circuidipity.com/secure-remote-access-using-ssh-keys.html">manage SSH keys for password-less logins to servers</a> and place in <tt class="docutils literal">$HOME/bin</tt>. Sample ...</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">SYNC_OPT</span><span class="o">=</span><span class="s2">&quot;--archive --verbose --delete&quot;</span>
<span class="nv">EXCLUDE_OPT</span><span class="o">=</span><span class="s2">&quot;--exclude=*[Cc]ache*/ --exclude=*[Tt]rash*/ --exclude=local/ \</span>
<span class="s2">--exclude=*[Tt]humbnail*/&quot;</span>
<span class="nv">DESTINATION</span><span class="o">=</span><span class="s2">&quot;netbook.lan:/path/to/backup/&quot;</span>

. <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.keychain/<span class="si">${</span><span class="nv">HOSTNAME</span><span class="si">}</span>-sh
rsync <span class="nv">$SYNC_OPT</span> <span class="nv">$EXCLUDE_OPT</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ <span class="si">${</span><span class="nv">DESTINATION</span><span class="si">}</span>/
</pre></div>
<p>Link: <a class="reference external" href="https://github.com/vonbrownie/homebin/blob/master/teleportHome.sh">teleportHome.sh</a> - A more complete script that verifies that DESTINATION exists; adds option to include (and exclude) items from a config file.</p>
</div>
<div class="section" id="client-automate">
<h3>5. Client: automate</h3>
<p>Automate the backups by running <tt class="docutils literal">crontab <span class="pre">-e</span></tt> and creating a <strong>cron job</strong>. Sample entry runs the backup script daily at 02:30 ...</p>
<div class="highlight"><pre><span></span><span class="c1"># m h  dom mon dow   command</span>
<span class="m">30</span> <span class="m">2</span> * * * . /home/USERNAME/.keychain/<span class="k">$(</span>/bin/hostname<span class="k">)</span>-sh<span class="p">;</span> /home/USERNAME/bin/teleportHome.sh netbook.lan:/path/to/backup/
</pre></div>
<p>Happy hacking!</p>
</div>
</div>

    <p class="articletags"><i class="fa fa-coffee"></i> More         &#8226; <a class="tag" href="http://www.circuidipity.com/tag-network.html">network</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-ssh.html">ssh</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-crypto.html">crypto</a>
        &#8226; <a class="tag" href="http://www.circuidipity.com/tag-linux.html">linux</a>
</p>
</div>

<!-- Nav links to previous|next article -->
<div id="navmenu">
    <hr />
    <p class="prevpost"><i class="fa fa-arrow-left"></i> Older<br />
        <a href="http://www.circuidipity.com/lvm-crypt-lv.html">LVM and encrypted Logical Volumes</a></p>
</div>


        <!-- footer -->
<div id="footer">
    <img class="imgfooter" src="./theme/images/footerbar.png" />
    <p class="contentinfo">
    <span class="noWrap">
        Copyright &#169; 2017 and
        <a rel="license" class="ccLicense" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA License</a> by
        <a rel="author" class="authorID" href="/">Daniel Wayne Armstrong</a>
    </span>
    <span class="noWrap">
        <i class="fa fa-globe"></i>
        Find me at <span class="whoa">daniel at circuidipity dot com</span>
    </span>
    <br />
    Don't miss a thing... updates by
    <a href="feed.xml">RSS</a> and
    <a class="subTweat" href="https://twitter.com/circuidipity">Twitter</a>
    </p>
</div></body>
</html>