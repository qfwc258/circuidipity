========================
Chromebook to Ubuntubook
========================

:date: 2015-05-02 17:30:00
:slug: c720-ubuntubook
:tags: chromebook, ubuntu, linux
:modified: 2017-06-19 01:10:00

**[ Update ]** `Ubuntubook is now a Stretchbook! <http://www.circuidipity.com/jessiebook-to-stretchbook.html>`_

Replace **Chrome OS** permanently with **Ubuntu 16.04 "Xenial Xerus"** on the **Acer C720 Chromebook**.

.. image:: images/jessiebook.png
    :align: right
    :alt: Ubuntu 16.04
    :width: 300px
    :height: 161px

Let's go!
=========

Running a full-featured Linux on this little laptop is a delight: lightweight, several hours battery life, inexpensive, and snappy performance. I started with `Debian <http://www.circuidipity.com/c720-chromebook-to-jessiebook.html>`_, followed by `Lubuntu 14.04 <http://www.circuidipity.com/c720-lubuntubook.html>`_ and `Arch <http://www.circuidipity.com/arch-install-encrypt.html>`_, and now running happy with `Ubuntu + i3 tiling window manager <http://www.circuidipity.com/20160501.html>`_.

This device is available in a few different configurations. Mine is the non-touchscreen model ``C720-2848`` with (non-expandable) **2GB RAM** and a (user-replaceable) **16GB SSD** [1]_.

0. Recovery Image
=================

Create a recovery image of Chrome OS (my C720 is model ``PEPPY C6A-N3C-A7O``) to enable restoring the Chromebook to its default configuration. This will require a spare USB stick of 2GB or better:

* Log into the Chromebook and let it auto update, as there sometimes are firmware updates... check the updating status in the browser at ``chrome://help``
* Insert the USB stick, enter ``chrome://imageburner`` and follow the directions to generate a recovery image

See: `Create a Chromebook recovery image <https://support.google.com/chromebook/answer/1080595?hl=en>`_ 

1. Prepare install media
========================

Download the `64-bit mini.iso installer <http://archive.ubuntu.com/ubuntu/dists/xenial/main/installer-amd64/current/images/netboot/>`_ and `flash the image <https://help.ubuntu.com/community/Installation/FromUSBStick>`_ to a USB stick.

**Alternative:** Add the image to a `USB stick with multiple Linux installers <http://www.circuidipity.com/multi-boot-usb.html>`_.

Using the minimal console installer (requires network connection) vs. the graphical `Ubuntu installer <https://help.ubuntu.com/community/Ubuntu/GetUbuntu>`_ provides more options during setup [2]_ and downloads all the latest packages.

2. SeaBIOS
==========

`SeaBIOS <http://www.coreboot.org/SeaBIOS>`_ in combination with **coreboot** provides an open-source legacy BIOS that enables access to the MBR and the ability to install an alternative OS on the Chromebook. All this good stuff involves jumping through a few simple hoops and not trembling in fear at the "scary white screen" that pops up at power up stating that the boot loader detects something is **very very wrong** with the Chromebook and helpfully suggests pressing the spacebar to begin recovery. **Do not press the spacebar** or the Ubuntu installation will be wiped from disk!

There are 2 different methods for configuring SeaBIOS in preparation for installing Ubuntu. The first method uses a few simple commands in the Chrome OS shell to place the Chromebook into **developer mode** and allow booting the USB install media and replacing Chrome OS with Ubuntu. The drawback is that scary screen appears at every boot and you must press ``CTRL+L`` to boot to legacy-mode and onward to GRUB and Ubuntu (and **ignore** the helpful prompt to press spacebar and inadvertently begin the adventure of wiping clean the SSD).

The second method involves setting new flags for the write-protected **Google Binary Block** (GBB) in the device firmware. Delay at the boot screen can be reduced to a one second timeout and the legacy-mode BIOS set as the system default (no key combo required). Pressing the spacebar is disabled from doing any harm to Ubuntu (the Chromebook just beeps). The drawback is that it involves the (very simple) removal of the device's bottom cover and the temporary removal of the **write-protect screw** from the motherboard to permit flashing new flags to the GBB... and this may void the Chromebook's warranty (one of the case screws lies underneath a sticker declaring the warranty void if disturbed).

Experimenting with alternate OS installs on the Chromebook I first employed the developer mode method followed by the write-protect screw removal. I prefer configuring the device to default to legacy-mode BIOS but I have employed both methods successfully and describe their respective steps below.

Happy hacking!

2.1 Write-Protect Screw Method
------------------------------

Disconnect power. Turn the Chromebook over facing bottom up and remove the 13 screws (not missing the one hidden under the warranty sticker). Gently pry the case off starting with the seam where the display connects to device. It comes away pretty easy.

This is what you see ...

.. figure:: images/c720-chromebook-annotated-innards.png
    :alt: C720 annotated innards
    :width: 800px
    :height: 558px

    [ Image: [3]_ The battery lock screw is #6 and the write-protect screw is #7 ].

.. role:: warning

:warning:`WARNING!` This will **wipe out** whatever is installed on the SSD ...

* Remove the write-protect screw
* Close back cover using only the battery lock screw to hold in place
* Re-connect power, boot Chromebook and wait until it displays ...                           
                                                                                
.. code-block:: bash
    
    Chrome OS is missing or damaged.                                            
    Please insert a recovery USB stick or SD card.                              

* Insert USB recovery media prepared in Step 0 and it will proceed to restore Chrome OS and reboot
* At default Chrome OS "Welcome!" screen open a terminal ``CTRL+ALT+F2`` (Right-arrow)
* Login as ``chronos`` (no password), then enter ``sudo su`` for superuser access

Set new GBB flags using the ``set_gbb_flags.sh`` script in Chrome OS. To enable short **developer mode** screen (1 second timeout) followed by **default legacy mode** boot use these flags ...

.. code-block:: bash

    GBB_FLAG_DEV_SCREEN_SHORT_DELAY 0×00000001
    GBB_FLAG_FORCE_DEV_SWITCH_ON 0×00000008
    GBB_FLAG_FORCE_DEV_BOOT_LEGACY 0×00000080
    GBB_FLAG_DEFAULT_DEV_BOOT_LEGACY 0×00000400

... which adds up to running in the shell ...

.. code-block:: bash

    /usr/share/vboot/bin/set_gbb_flags.sh 0x489

Shutdown with ...

.. code-block:: bash

    # shutdown -h now

... and disconnect the power ...

* Remove the bottom cover again and reinstall the write-lock screw to protect the BIOS
* Close cover and reinstall all the case screws

Re-connect the power, insert the USB stick prepared in Step 1, and power up the Chromebook [4]_.

See: `Useful GBB flags <http://www.coreboot.org/pipermail/coreboot/2014-January/077083.html>`_ for `another new free software machine <https://blogs.fsfe.org/the_unconventional/2014/04/20/c720-debian/>`_

2.2 Developer Mode Method
-------------------------

The alternative to removing the write-protect screw above is to place the Chromebook into developer mode using the Chrome OS shell before booting the USB install media ...

* With the Chromebook off... Hold down ``ESC+F3`` (Refresh) keys and power on the device
* Invoke Recovery, and at the Recovery screen press ``Ctrl+D``
* Device will prompt for confirmation, press ``ENTER`` and the system reboots into developer mode
* Scary white boot screen appears and you need to press ``Ctrl+D`` to continue boot [5]_

Enable the **USB Boot** and **Legacy BIOS** modes by opening the shell with ``Ctrl+Alt+T`` and enter ``shell``. Set ``dev_boot_usb`` and ``dev_boot_legacy`` to active ...

.. code-block:: bash

    $ sudo crossystem dev_boot_usb=1
    $ sudo crossystem dev_boot_legacy=1

Insert the USB stick prepared in Step 1, reboot the Chromebook and press ``CTRL+L`` at the boot screen to enter legacy boot mode.

See: `Chromium OS <http://www.chromium.org/chromium-os>`_ developer information for the `Acer C720 Chromebook <http://www.chromium.org/chromium-os/developer-information-for-chrome-os-devices/acer-c720-chromebook>`_

3. Install Ubuntu
==================

My `visual screenshot tour <http://www.circuidipity.com/ubuntu-trusty-install.html>`_ of installing Ubuntu 16.04 - a `Long Term Support (LTS) <https://wiki.ubuntu.com/Releases>`_ release. Ubuntu's minimal install image makes it easy to create a console-only base configuration that can be later customized for various tasks and alternate desktops. I like the `lightweight and delightful i3 window manager <http://www.circuidipity.com/20160501.html>`_. 

Chromebook's SSD will be divided into 3 partitions ...

* sda1 is a 300MB ``boot`` partition 
* sda2 is a 1GB LUKS encrypted ``swap`` partition using a **random key**
* sda3 uses the remaining space as a LUKS encrypted ``root`` partition using a **passphrase**

**Update:** I replaced the factory-installed SSD with a 256GB device and a revised partition scheme ...

* sda1 is a 24GB ``root`` partition
* sda2 is a 2GB LUKS encrypted ``swap`` partition using a **random key**
* sda3 uses the remaining space as a LUKS encrypted ``home`` partition using a **passphrase**

4. Touchpad
===========

Ubuntu installs a kernel with built-in support for the Chromebook's touchpad. Per-session modifications of touchpad settings can be made using ``synclient`` ...

.. code-block:: bash

    $ synclient                 # display current settings
    $ synclient TapButton3=2    # 3-finger tap = middle-click

To make any desired touchpad settings permanent create a configuration file in ``/etc/X11/xorg.conf.d`` ...

.. code-block:: bash

    $ sudo mkdir /etc/X11/xorg.conf.d
    $ sudo cp /usr/share/X11/xorg.conf.d/50-synaptics.conf /etc/X11/xorg.conf.d/50-c720-touchpad.conf

Modify this file to adjust timeouts, add tap-mouse actions (2-finger tap = right-click, 3-finger tap = middle-click), and 2-finger scrolling.

Sample config ...

.. code-block:: bash

    Section "InputClass" 
        Identifier      "touchpad peppy cyapa" 
        MatchIsTouchpad "on" 
        MatchDevicePath "/dev/input/event*" 
        MatchProduct    "cyapa" 
        Option          "FingerLow" "5" 
        Option          "FingerHigh" "5"
        Option          "VertEdgeScroll" "0"
        Option          "VertTwoFingerScroll" "1"
        Option          "HorizTwoFingerScroll" "1"
        Option          "AreaRightEdge" "850"
        Option          "AreaLeftEdge" "50"
        Option          "TapButton1" "1"
        Option          "TapButton2" "3"
        Option          "TapButton3" "2"
    EndSection

**Note:** If using Ubuntu's default Unity desktop ... you may find the 3-finger middle-click option requires a manual reset each session.

**Fix:** Stop the Gnome Settings daemon from overriding ``50-c720-touchpad.conf`` ...

.. code-block:: bash

    $ gsettings set org.gnome.settings-daemon.plugins.mouse active false 

See: `50-c720-touchpad.conf <https://github.com/vonbrownie/linux-post-install/blob/master/config/c720_ubuntubook/etc/X11/xorg.conf.d/50-c720-touchpad.conf>`_, and pages for `Touchpad Synaptics <https://wiki.archlinux.org/index.php/Touchpad_Synaptics>`_ and the `C720 Chromebook <https://wiki.archlinux.org/index.php/Acer_C720_Chromebook#configuration>`_ on `ArchWiki <https://wiki.archlinux.org/>`_

5. SSD
======

The `swappiness <https://en.wikipedia.org/wiki/Swappiness>`_ parameter controls the preference of the kernel to move processes out of physical memory to the swap partition. Range is ``0-100``, default is set to ``60`` and lower values cause the kernel to avoid swapping and higher values prompt more frequent swap use.

Check the current swappiness value ...

.. code-block:: bash

    $ cat /proc/sys/vm/swappiness

To reduce writes on the SSD set a low value of ``1`` by setting ``vm.swappiness=1`` in ``/etc/sysctl.conf``.

**TRIM** optimizes SSD performance and is enabled by adding the ``discard`` option to ``/etc/crypttab`` and ``/etc/fstab``. Ubuntu auto-magically configures ``crypttab`` but ``fstab`` needs to be set manually.

Sample ``fstab`` ...

.. code-block:: bash

    # <file system> <mount point>   <type>  <options>       <dump>  <pass>
    # / was on /dev/sda1 during installation
    UUID=<______string___>  /              ext4    relatime,discard,errors=remount-ro 0       1
    /dev/mapper/sda3_crypt /home           ext4    relatime,discard        0       2
    /dev/mapper/sda2_crypt none            swap    sw,discard              0       0

After modifying ``fstab`` update ``/boot/initrd.img-*`` by running ...

.. code-block:: bash
 
    $ sudo update-initramfs -u -k all                                                      

See: `TRIM configuration on solid-state drives <http://www.linuxjournal.com/content/solid-state-drives-get-one-already>`_

6. Suspend
==========

**Problem:** Suspend-and-resume generates a stream of errors ...

.. code-block:: bash

    ehci-pci 0000:00:1d.0: port 1 resume error -19
    ehci-pci 0000:00:1d.0: port 2 resume error -19
    usb usb3-port1: over-current condition
    usb usb3-port1: connect-debounce failed
    usb usb3-port2: over-current condition
    usb usb3-port2: connect-debounce failed

... and blocks the Chromebook from executing a proper restart/shutdown.

**FIX:** Create ``/lib/systemd/system-sleep/ehci-pci.sh`` ...  [6]_

.. code-block:: bash

    #!/bin/bash

    case $1/$2 in
        pre/*)
        # Unbind ehci for preventing error
        echo -n "0000:00:1d.0" | tee /sys/bus/pci/drivers/ehci-pci/unbind
        ;;
        post/*)
        # Bind ehci for preventing error
        echo -n "0000:00:1d.0" | tee /sys/bus/pci/drivers/ehci-pci/bind
        ;;
    esac

... and make it executable ...
                                                                                    
.. code-block:: bash                                                                
                                                                                    
    $ sudo chmod 755 /lib/systemd/system-sleep/ehci-pci.sh           
                                                                                    
Configure boot options in ``/etc/default/grub`` ...

.. code-block:: bash                                                            
                                                                                
    GRUB_CMDLINE_LINUX_DEFAULT="quiet splash tpm_tis.force=1" 
                                                                                
... save the changes and run ...

.. code-block:: bash                                                            
                                                                                
    $ sudo update-grub                                                          
                                                                                
Suspend now works reliably when triggered from Ubuntu's shutdown menu or closing the lid and will resume the system with the desktop locked and a password prompt.

Source: `ehci-pci.sh <https://github.com/vonbrownie/linux-post-install/blob/master/config/c720_ubuntubook/lib/systemd/system-sleep/ehci-pci.sh>`_

7. Keyboard Shortcuts
=====================

Top row on the keyboard with the shortcut icons (brightness, volume, etc.) identify in Linux as the ``F1-F10`` keys and the Search key (in the ``CapsLk`` position) acts as the ``Super`` (Windows) modifier key.

Create keyboard shortcuts by first installing ...

* ``xbindkeys`` - associate keys to shell commands
* ``xbacklight`` - set backlight level using RandR
* ``pulseaudio-utils`` - manage sound with ``pactl``
* ``xvkbd`` - send characters to another client 

.. code-block:: bash

    $ sudo apt install xbindkeys xbacklight pulseaudio-utils xvkbd

7.1 Direction, Brightness, Volume, Page Keys
--------------------------------------------

.. code-block:: bash

    $ xbindkeys -k

Enable the function keys to modify the sound and brightness settings by creating ``~/.xbindkeysrc`` ...

.. code-block:: bash

    # ~/.xbindkeysrc

    # backward/forward
    "xvkbd -xsendevent -text "\A\[Left]""
    F1 

    "xvkbd -xsendevent -text "\A\[Right]""
    F2 

    # backlight decrease/increase
    "xbacklight -dec 10"
    F6
    "xbacklight -inc 10"
    F7

    # volume mute/decrease/increase
    # pactl - control a running pulseaudio server
    # pactl list sinks - retrieve info
    # on my c770 chromebook... single audio sink is 'Sink #0'
    # named 'alsa_output.pci-0000_00_1b.0.analog-stereo'
    "pactl set-sink-mute alsa_output.pci-0000_00_1b.0.analog-stereo toggle"
    F8
    "pactl set-sink-volume alsa_output.pci-0000_00_1b.0.analog-stereo -10%"
    F9
    "pactl set-sink-volume alsa_output.pci-0000_00_1b.0.analog-stereo +10%"
    F10

    # page up/down, home, end
    "xvkbd -xsendevent -text '\[Page_Up]'"
    Alt + Up

    "xvkbd -xsendevent -text '\[Page_Down]'"
    Alt + Down

    "xvkbd -xsendevent -text '\[Home]'"
    Alt + Left

    "xvkbd -xsendevent -text '\[End]'"
    Alt + Right

Enable the new key shortcuts by running ...

.. code-block:: bash

    $ xbindkeys

Ubuntu auto-detects ``~/.xbindkeysrc``  and will run ``xbindkeys`` on the next login.

See: `xbindkeysrc <https://github.com/vonbrownie/dotfiles/blob/master/.xbindkeysrc.chromebook>`_, `Xbindkeys <https://wiki.archlinux.org/index.php/Xbindkeys>`_, and another sample `Chromebook-friendly xbindkeysrc <https://github.com/alexpatel/dotfiles/blob/master/xbindkeysrc>`_

7.2 Power Key
-------------

Power key in upper-right corner ignores any configuration in the window manager and triggers poweroff without delay when pressed (easy to do by accident as its positioned next to ``backspace``).

If you want to disable the power key edit ``/etc/systemd/logind.conf`` and set ``HandlePowerKey=ignore``.

8. Wireless
===========

**Update:** With the >= 4.2 kernels I have not been required to make any modifications. Works OK.

There are a few settings to modify to improve performance of Chromebook's wireless chipset. Identify the card and parameters ...

.. code-block:: bash

    $ lspci | grep -i net
    01:00.0 Network controller: Qualcomm Atheros AR9462 Wireless Network Adapter (rev 01)
    $ modinfo ath9k | grep parm
    parm:           debug:Debugging mask (uint)
    parm:           nohwcrypt:Disable hardware encryption (int)
    parm:           blink:Enable LED blink on activity (int)
    parm:           btcoex_enable:Enable wifi-BT coexistence (int)
    parm:           bt_ant_diversity:Enable WLAN/BT RX antenna diversity (int)
    parm:           ps_enable:Enable WLAN PowerSave (int)
    parm:           use_chanctx:Enable channel context for concurrency (int)

Create ``/etc/modprobe.d/ath9k.conf`` with the following options ...

.. code-block:: bash
  
    options ath9k bt_ant_diversity=1 ps_enable=0

See: `ath9k.conf <https://github.com/vonbrownie/linux-post-install/blob/master/config/c720_ubuntubook/etc/modprobe.d/ath9k.conf>`_, `ath9k wireless driver <http://wireless.kernel.org/en/users/Drivers/ath9k>`_ and `bluetooth coexistence <http://wireless.kernel.org/en/users/Drivers/ath9k/btcoex>`_                                                       

9. Microphone
=============

Confirm the microphone is unmuted in ``alsamixer``. Create ``/etc/modprobe.d/snd-hda-intel.conf`` ...

.. code-block:: bash

    options snd_hda_intel model=,alc283-dac-wcaps                                        
                                                                                       
... and restart. Give it a try ...

.. code-block:: bash

    $ arecord -d 5 chr-mic.wav                                                            
    $ aplay chr-mic.wav

10. Good stuff
==============

* My former `Lubuntu 14.04 LTS install on the Chromebook <http://www.circuidipity.com/c720-lubuntubook.html>`_ and configuration (under ``upstart`` init vs ``systemd`` in the current 15.10)
* Arch Linux C720 installation with `useful post-install details <https://wiki.archlinux.org/index.php/Acer_C720_Chromebook>`_
* Turn Chromebooks into `Ubuntu-based code learning machines for kids <http://blog.codestarter.org/post/93985346780/how-we-turn-199-chromebooks-into-ubuntu-based-code>`_
* Lightweight `i3 tiling window manager <http://www.circuidipity.com/i3-tiling-window-manager.html>`_ is snappy on the Chromebook's modest hardware

Happy hacking!

Notes
-----

.. [1] Device information `output of lshw, lspci, and lsusb <https://github.com/vonbrownie/linux-post-install/tree/master/config/c720_ubuntubook/doc>`_.

.. [2] Specifically in this instance, the Ubuntu console installer provides a random key option for the encrypted swap partition.

.. [3] Image courtesy of `Chromium <http://www.chromium.org/chromium-os/developer-information-for-chrome-os-devices/acer-c720-chromebook#TOC-Firmware>`_.

.. [4] Whenever you remove battery power to the Chromebook (like opening up the case) the hardware clock on the motherboard resets to a future year (mine travelled to 2040). Providing a network connection is up during the Ubuntu installation the system should fetch a correct time from a NTP server. Otherwise fix the `fallout from an incorrect clock <https://blogs.fsfe.org/the_unconventional/2014/04/20/c720-debian/>`_ by re-mounting partitions read-only and correct filesystem timestamps using ``fsck``.

.. [5] Switching between developer and normal (non-developer) modes will remove user accounts and their associated information from the Chromebook.

.. [6] Some HOWTOs talk about adding ``modprobe.blacklist=ehci_hcd,ehci_pci`` but in Ubuntu they are compiled into the kernel.
